# 会议备忘录：需求评审与问题研讨

**日期:** 2025年08月16日
**与会人员:**
*   石永昌 (PM/产品)
*   陈云霄 (前端)
*   ZC@WorkGroup (后端)

---

## 会议核心议题

本次会议主要围绕测试反馈的几个核心问题展开，并对现有功能进行深化和澄清。主要议题包括：
1.  已审批完成的申请单如何处理错误（撤销/回退）。
2.  数据字典和客户资料的导入导出功能细节。
3.  新的账期管理与工作号批量关闭机制。
4.  多个前端体验优化和后端逻辑调整。

---

### 议题一：申请单审批流程的回退与作废

**背景：**
测试提出，当一个申请单（主营业务申请单或OA费用申请单）已经走完所有审批流程，甚至财务已经付款，但事后发现单据内容有误时，系统应如何处理。

**讨论要点：**
1.  **需求场景：** 错误可能在任何阶段被发现，包括最终付款环节（如银行余额不足导致付款失败，客户要求取消交易）。
2.  **核心目标：** 允许业务员修改错误的申请单，并重新提交。关键在于要释放被锁定的费用，以便后续操作。
3.  **方案探讨：**
    *   **方案A（物理删除）：** 直接删除申请单，让用户重新创建。
        *   **缺点：** 业务操作痕迹丢失，不符合审计要求。且删除明细时，恢复关联费用的逻辑依然复杂。此方案被否决。
    *   **方案B（一键回退）：** 提供一个有权限控制的“撤销”或“回退”功能，将申请单状态直接恢复到“未提交”的初始状态。
        *   **流程：**
            1.  **权限控制：** 此操作需要专门的权限，并非人人可用。
            2.  **记录日志：** 在执行回退前，系统需要将当前申请单的所有状态、审批节点信息生成快照，并存入系统日志备查。
            3.  **清空审批流：** 删除所有已生成的审批流节点。
            4.  **状态变更：** 将申请单主表的状态改回“初始状态/未提交”。
            5.  **保留明细：** 申请单的表头和明细数据予以保留，允许用户在此基础上直接修改。由于状态回退，用户可以编辑明细，从而触发 `trigger` 自动更新和释放关联的费用。
            6.  **消息通知：** 执行回退操作时，系统应向该申请单审批流上的所有相关人员发送一条通知，告知他们该单据已被撤销。
4.  **与账期关闭的关系：**
    *   会议确认，即使关联的工作号（PR Job）因账期结束而被“关闭”，申请单的回退功能依然有效。
    *   工作号的关闭仅锁定其自身费用的修改，但并不阻止用户在申请单中调整或移除与该工作号费用的关联。用户可以通过新建一个后续月份的“调账工作号”（如记录负数费用）来处理已关闭工作号的账务差异，并将新旧费用合并在一个申请单里提交。

**会议决议：**
*   采用 **方案B（一键回退）**。
*   此功能适用于 **主营业务申请单** 和 **OA费用申请单**。
*   拒绝（Reject）操作的逻辑也需要同步调整，确保拒绝后同样能将单据退回至初始状态，以释放锁定的费用。

**行动项：**
*   **[后端]** `ZC@WorkGroup`：
    1.  创建新的“一键回退”接口，实现上述方案B的全部逻辑（权限验证、日志记录、删除审批节点、变更主单据状态、发送通知）。
    2.  修改现有“拒绝”操作的逻辑，使其同样能将单据状态回退至初始状态。
*   **[前端]** `陈云霄`：
    1.  在申请单界面上，根据权限显示“撤销/回退”按钮。
    2.  调用新的接口实现该功能。

---

### 议题二：导入导出功能细化

**背景：**
需要明确数据字典和客户资料的Excel导入导出具体逻辑。

**讨论要点：**
1.  **导出范围：**
    *   后端最初设计为一次性导出所有关联字典，现更正为 **按类型分别导出**。
    *   前端界面上，用户选择特定字典类型（如“币种”、“汇率”等），后端根据传入的类型标识导出相应的数据。
2.  **简单字典（数据字典）：**
    *   导出时，仅导出指定分类下的字典项，不导出字典分类本身。
    *   导入时，也应在指定分类下进行导入。前端需传递分类的 `code` 给后端。
3.  **导入逻辑：**
    *   **重复数据处理：** 对于 `code` 重复的记录，会议倾向于 **覆盖（Update）** 现有数据，认为这更符合用户“让数据与导入文件一致”的意图。
    *   **历史数据问题：** 讨论到“导入前清空”的方案，但考虑到汇率等需要保留历史记录的场景，此方案不适用。
    *   **依赖关系：** 后端提出，字典间可能存在依赖。导入时会做验证，如果依赖的字典数据不存在，将阻止导入。
4.  **客户资料：**
    *   现阶段，导入导出功能 **仅处理主表**，子表的处理暂缓。

**会议决议：**
*   导入导出功能需按字典类型进行。
*   简单字典的导入导出以选定分类为维度。
*   重复数据导入策略暂定为 **覆盖**。

**行动项：**
*   **[后端]** `ZC@WorkGroup`：
    1.  调整导出接口，支持按类型导出数据字典。
    2.  实现简单字典按分类导入导出的逻辑。
    3.  确认导入逻辑，特别是存在依赖关系时的处理方式。
*   **[前端]** `陈云霄`：
    1.  提供让用户选择字典类型的界面。
    2.  在导入导出时，向后端传递正确的类型/分类参数。

---

### 议题三：账期管理与工作号关闭机制

**背景：**
引入新的“账期”概念，以统一管理各公司工作号的月度关闭，确保与金蝶财务系统对齐。

**讨论要点：**
1.  **账期概念：**
    *   每个公司（机构）有自己独立的账期，格式为 `YYYYMM`（如 `202508`），代表一个自然月。
    *   账期信息将存储在一个与“机构”一对一关联的 **参数表** 中。
2.  **关闭账期操作：**
    *   这是一个有权限的操作，通常由财务人员执行。
    *   执行“关闭账期”时，系统会自动将所有“财务日期”落在该账期内的工作号（PR Job）状态置为“已关闭”。
    *   关闭后，该工作号的任何费用将无法再被修改。
    *   同时，系统的当前账期参数会自动递增至下一个月（如从 `202508` 变为 `202509`）。
3.  **取消单票关闭：**
    *   一旦引入统一的“关闭账期”功能，原有的手动、单票、批量关闭工作号的功能将被 **废弃**。所有工作号的关闭都应通过月结时的“关闭账期”操作完成。
4.  **机构参数表：**
    *   需要新建一个与机构关联的参数表，用于存放各公司特有的配置信息。
    *   **当前需要字段：**
        *   `当前账期`（`current_accounting_period`）：字符串，如 `202508`，只读，通过“关闭账期”操作更新。
        *   `账单抬头1`、`账单抬头2`、`账单落款`：字符串，用于打印报表。
    *   此参数表的编辑也需要单独的权限。

**会议决议：**
*   引入公司维度的账期管理机制。
*   废除旧的关闭工作号方式，统一使用“关闭账期”功能。
*   新建机构参数表用于存储账期及其他公司级配置。

**行动项：**
*   **[后端]** `ZC@WorkGroup`：
    1.  创建新的“机构参数表”及其模型。
    2.  创建“关闭账期”接口，实现批量关闭工作号和账期自动递增的逻辑。
    3.  提供对机构参数表的CRUD接口，并确保“当前账期”字段的更新逻辑正确。
*   **[前端]** `陈云霄`：
    1.  创建“机构参数配置”界面，用于编辑抬头、落款等信息，并显示只读的“当前账期”。
    2.  在“单票审核”或相关财务功能区，添加“关闭账期”的按钮，并配置相应权限。

---

### 议题四：其他功能优化与调整

1.  **财务日期逻辑变更：**
    *   **问题：** `KL_Job` 中的财务日期存在 `2001-01-01` 的无效默认值。
    *   **新逻辑：**
        *   财务日期变为 **只读** 字段，其值由其他日期联动决定。
        *   **进口业务** (海运/空运): `财务日期` = `到港日期`。
        *   **出口业务** (海运/空运): `财务日期` = `开航日期`。
        *   当`到港/开航日期`为空时，`财务日期`也为空。
        *   **约束：** `到港/开航日期`不能选择当前月份之前的日期（例如，8月份不能选择7月及以前的日期）。
    *   **行动项：** `[后端]` `[前端]` 双方配合完成此联动和约束逻辑。

2.  **费用列表显示申请单详情：**
    *   **需求：** 在费用列表（如工作号下的费用tab），用户希望点击“已申请金额”时，能看到这笔费用是在哪个/哪些申请单中被引用的。
    *   **决议：** 点击后弹出一个小窗口，列表显示相关申请单的关键信息（申请单号、申请金额、申请人、申请时间）。暂时无需实现点击跳转功能，能复制单号即可。
    *   **行动项：** `[后端]` 提供查询接口，`[前端]` 实现弹窗展示。

3.  **OA费用申请单增加公司字段：**
    *   **需求：** OA费用申请单主表需要增加一个“公司”字段，关联到客户资料表。
    *   **背景：** 用户会将一些个人费用（非公司客户）也录入客户资料，以便于此场景下选用。
    *   **行动项：** `[后端]` 在OA申请单实体中增加 `customerId` 字段。`[前端]` 在界面上增加对应的公司选择器。

4.  **客户资料有效性管理：**
    *   **问题：** 客户资料目前无法安全删除（因为存在关联业务），但需要一种方式将其“停用”。
    *   **决议：**
        *   增加 **有效/无效** 状态（软删除）。
        *   在客户资料列表页，增加一个带权限的按钮，用于切换客户的“有效/无效”状态。此操作调用一个单独的接口，不与其他编辑操作混合。
        *   在所有选择客户的下拉框或搜索框中，**默认只显示“有效”的客户**。
    *   **行动项：** `[后端]` `[前端]` 配合增加此状态及相关操作。

5.  **客户选择器优化：**
    *   **需求：** 用户反馈，在各类单据中选择客户时，当前的下拉搜索框信息太少，希望能有一个功能更丰富的弹出式选择器，类似单机版。
    *   **决议：**
        *   改为 **弹出式窗口** 进行客户选择。
        *   弹窗内的列表需要显示更多字段，如：**名称、简称、财务编码、是否超期、是否超额**。
        *   提供按 **名称、简称、财务编码** 进行模糊搜索的功能。
        *   需要根据业务场景自动过滤客户类型（如选“委托单位”时只显示客户，选“承运人”时只显示航空公司/船公司）。
    *   **行动项：** `[前端]` `陈云霄` 负责实现这个通用的客户选择弹窗组件。`[后端]` 确保查询接口能支持相关过滤和返回所需字段。

---

### 项目进度与排期

*   **目标日期：** 所有上述功能和修改，争取在 **9月2号之前** 完成，以便客户方有时间进行上线前的最终测试。
*   **风险：** 本次会议提出的需求变更较多，尤其是“一键回退”和“账期管理”涉及核心流程，存在一定复杂度。团队需紧密合作，争取在2周内完成开发。