# 会议纪要

**日期:** 2025-01-19 
**与会者:** 永昌 石, chong z, cyx
**会议目标:** 讨论财务模块的复杂需求，并规划下周的开发任务。

---

## 1. 会议开场与技术问题排查

- **问题:** 会议开始时，与会者遇到了网络连接问题。开启 VPN 后，微信无法连接，但不开启 VPN 则无法访问 OneDrive 上的文件。
- **讨论:**
    - 确认问题出现在台式机上。
    - 讨论了 VPN 代理和分流模式的设置，`chong z` 建议使用分流模式（智联模式）来解决冲突。
    - `永昌 石` 尝试后，网络连接和语音卡顿问题有所缓解。
- **结论:** VPN 的全局代理模式影响了部分本地应用的网络连接，建议使用分流或智能代理模式。

---

## 2. 核心议题：客户财务流程的复杂性

`永昌 石` 详细介绍了客户（老郭的公司）在"实收实付"模块提出的复杂需求，这与现有系统设计有很大差异。

### 2.1. 收付款的复杂场景

- **多种情况:** 收款有至少6种情况，付款有5种情况，每种情况产生的会计科目都不同。
- **差额处理:**
    - **收款不足:** 如客户欠款1万，只付9千，剩余1千可能作为坏账或下次再付。
    - **收款超额:** 多余款项需转入预收款。
- **多笔支付:** 一笔申请单的费用，可能由客户通过多个银行账户、用多种货币（如人民币和美金）分多笔结清。

### 2.2. 外币与汇兑损益处理

- **多汇率问题:** 客户的业务流程涉及3个不同的汇率：
    1. 挂账时（应收/应付）的汇率。
    2. 收款时的汇率。
    3. 核销时的汇率。
    - *现状: 当前系统只用到了1个汇率。*
- **汇兑损益:** 收到美金后，立即折算成本位币，并产生汇兑损益。
- **损益承担:** 损益由谁承担（业务员、公司，或双方分摊）导致了更复杂的财务处理。

### 2.3. 现有系统无法满足需求

- **结论:** 当前系统的结算页面和逻辑无法满足客户复杂的财务流程。
- **行动计划:** `永昌 石` 决定暂停此模块的开发，将在下周一与客户再次沟通，梳理清晰业务逻辑后再继续。

---

## 3. 下周开发任务规划：OA 费用申请单

鉴于财务结算模块的复杂性，团队决定下周先开发新的 **OA 日常费用申请单** 功能。

### 3.1. 功能概述

- **目的:** 用于处理日常费用（如差旅、报销），独立于主营业务的费用申请。
- **核心实体:**
    1. **日常费用种类字典:** 一个新的基础数据字典，用于定义如"差旅费"、"办公费"、"电话费"等，与主营业务的费用种类（如仓储费、报关费）分开。
    2. **OA 申请单主表:** 包含申请人、登记人、申请时间、是否借款、是否导入金蝶等主信息。
    3. **费用明细表:** 记录具体的费用条目，如费用种类、发生时间、发票号、币种、汇率、金额等。
    4. **文件明细表:** 用于上传发票等附件。
- **审批流程:** 复用现有的自定义工作流引擎。

### 3.2. 关键字段与逻辑讨论

- **申请人 vs. 登记人:**
    - **场景:** 为解决高管（如老郭）不使用系统，由助理或财务代为提交费用的问题。
    - **设计:**
        - **主动申请:** "申请人"和"登记人"默认为当前登录用户。
        - **代为登记:** 提供一个"登记费用"的入口，此时"登记人"为当前登录用户，但"申请人"需要手动选择，以确保费用归属正确。
- **结算信息:**
    - **字段:** `结算方式` 和 `银行账户`。
    - **处理方式:** 这两个字段在申请单创建和审批过程中不可编辑。在审批流程全部结束后，通过一个独立的"结算"接口来填写，以确保流程的严谨性。这与现有"申请发票"的模式保持一致。

### 3.3. 数据库表结构设计

基于会议讨论和后续沟通，确定了三个核心表的结构：

#### 3.3.1. 日常费用类型字典表

| 字段 | 说明 |
|------|------|
| id | 主键，GUID |
| orgid | 挂orgid下，可复制 |
| code | 费用代码 |
| DisplayName | 显示名称 |
| ShortName | 简称 |
| Remark | 备注 |
| 科目代码 | 日常费用每种费用对应一科目，用于财务核算 |

#### 3.3.2. OA费用申请单主表

| 字段 | 说明 |
|------|------|
| id | 主键，GUID |
| orgid | 所属机构 |
| 申请人 | 员工账号Id |
| 申请时间 | 申请提交时间 |
| 是否借款 | bool型，true表示借款申请，false表示报销申请 |
| 是否导入财务软件 | 作为后期金蝶财务软件导入条件 |
| 登记人 | 主动申请时，登记人=申请人（申请人、登记人不可选择，为登录人），财务帮登记时选择申请人，登记人为登录人 |
| 相关客户 | 字符串即可，不用从客户资料中选择 |
| 收款银行 | 报销时的收款银行 |
| 收款户名 | 报销时的户名 |
| 收款账户 | 报销时的账户 |
| 所谈事项 | 大文本，审批流程成功结束后，弹出窗口填入；审批流程成功完成后通过单独结算接口处理 |
| 备注 | 大文本，审批流程成功结束后，弹出窗口填入；审批流程成功完成后通过单独结算接口处理 |
| 结算方式 | （现金、银行），后期现金财务科目在科目设置中读取；审批流程成功完成后通过单独结算接口处理 |
| 银行账户 | 上面结算方式是银行时选择本公司信息中的银行账户id，审批流程成功完成后通过单独结算接口处理 |

#### 3.3.3. OA费用申请单明细项表

| 字段 | 说明 |
|------|------|
| id | 主键，GUID |
| 申请单id | 关联主表 |
| 日常费用种类id | 关联费用类型字典 |
| 费用发生时间 | 费用实际发生的时间 |
| 发票号 | 发票编号 |
| 币种 | 货币类型 |
| 汇率 | 汇率 |
| 金额 | 费用金额 |
| 备注 | 费用说明 |

#### 3.3.4. 文件明细表

| 字段 | 说明 |
|------|------|
| id | 挂申请单id下的文件对象 |
| 申请单id | 关联主表 |
| 文件信息 | 发票等文件 |

---

## 4. Bug 修复与问题跟进

- **问题:** `永昌 石` 在测试"计提总应收"导出功能时，系统提示"没有符合条件的费用"。
- **原因分析:**
    1. **日期字段错误:** 查询条件使用了错误的日期字段（应为工作号的财务日期）。
    2. **缺少状态过滤:** 未加入"工作号已关闭"的状态作为查询条件。
- **负责人:** `cyx` 将负责修复此问题。

---

## 5. 项目策略与版本管理讨论

- **问题:** 为客户（老郭）定制的复杂财务流程，可能导致该软件版本无法被其他客户使用。
- **讨论:**
    - 如果不使用客户的真实数据和流程进行测试，无法验证系统的可用性。
    - 但深度定制会牺牲产品的通用性。
- **初步结论:**
    - 先为付费客户完成定制化需求。
    - 技术上，可以创建一个新的代码分支来隔离这些定制化修改。
    - 未来再考虑如何将通用功能与定制功能分离，或维护不同的版本。

---

## 6. 技术架构和设计决策

### 6.1. 审批流程设计
- **决定:** 复用现有的自定义工作流引擎，无需重新开发审批机制。
- **流程类型:** 在现有流程设置中新增"OA费用申请"类型，与主营业务收入、支出流程并列。

### 6.2. 数据库设计原则
- **字段分离:** 结算相关字段（结算方式、银行账户）与申请字段分离，避免在审批过程中被误修改。
- **权限控制:** 结算字段只有在审批完成后才能通过专门的结算接口进行填写。

### 6.3. 前端入口设计
- **双入口设计:** 
  - "申请费用"：申请人和登记人均为当前用户
  - "登记费用"：登记人为当前用户，申请人可选择其他人

---

## 7. 其他技术讨论

### 7.1. VPN和网络工具
- **工具对比:** 讨论了"快连"、"Clash"等不同 VPN 工具的优劣、付费模式（包月 vs. 按流量）和稳定性。
- **建议:** 使用分流模式解决VPN与本地应用的兼容性问题。

### 7.2. 微软 M365 商务版
- **采购经验:** `chong z` 分享了购买 M365 商务版的复杂经历，特别是个人账户无法直接升级，必须创建新的"企业下的个人账户"。
- **版本差异:** 讨论了不同区域版本（如简中版、台湾版、国际版）在功能（如 Copilot）上的差异。

---

## 会后行动项

| 任务 | 负责人 | 截止日期 | 优先级 |
| :--- | :--- | :--- | :--- |
| 1. 修复"计提总应收"导出功能的Bug（日期字段和状态过滤） | `cyx` | 本周内 | 高 |
| 2. 与客户沟通，梳理"实收实付"的详细业务逻辑 | `永昌 石` | 下周一 | 高 |
| 3. 开发日常费用种类字典基础数据管理功能 | `cyx`, `chong z` | 下周 | 高 |
| 4. 开发OA费用申请单主表和明细表的CRUD功能 | `cyx`, `chong z` | 下周 | 高 |
| 5. 集成现有工作流引擎，支持OA费用申请审批 | `chong z` | 下周 | 中 |
| 6. 实现文件上传功能（发票等附件） | `cyx` | 下周 | 中 |
| 7. 开发结算接口，处理审批完成后的结算信息填写 | `chong z` | 下下周 | 中 |
| 8. 研究并创建新代码分支，用于客户的定制化开发 | `chong z` | 适时 | 低 |

---

## 技术实现状态

根据代码检查，发现以下功能已经部分实现：

### 已完成
1. ? **日常费用种类字典** (`DailyFeesType`) - 基础实体和扩展方法已实现
2. ? **OA费用申请单实体** (`OaExpenseRequisition`) - 主表和明细表结构已完成
3. ? **控制器基础框架** (`OaExpenseController`) - CRUD接口已实现
4. ? **权限控制逻辑** - 基于用户角色和数据归属的权限检查
5. ? **数据验证和扩展方法** - 实体验证和业务逻辑方法

### 待完成
1. ? **工作流集成** - 需要与现有审批系统集成
2. ? **文件管理** - 附件上传和管理功能
3. ? **编码规则** - 申请单号自动生成逻辑
4. ? **结算接口** - 审批后的结算信息处理
5. ? **前端界面** - 用户界面和交互逻辑
6. ? **财务软件集成** - 金蝶系统导入功能

### 需要调整
1. ?? **计提总应收导出** - 日期字段和状态过滤bug修复
2. ?? **实收实付模块** - 等待客户需求澄清后重新设计

---

**备注:** 本次会议确立了OA费用申请单的技术架构和实现路径，为下周的开发工作提供了明确的方向。同时识别了现有财务模块的复杂性，需要进一步的需求澄清才能继续开发。
