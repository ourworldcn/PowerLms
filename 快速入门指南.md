# PowerLms 快速入门指南

## 开发环境准备

### 必备软件
1. **Visual Studio 2022** 或 **Visual Studio Code**
2. **.NET 6 SDK** 或更高版本
3. **Microsoft SQL Server** (本地或远程)
4. **Git** 版本控制工具

### 推荐工具
- **SQL Server Management Studio** (SSMS)
- **Postman** 或 **Insomnia** (API 测试)
- **Redis** (可选，用于缓存)

## 项目结构

```
PowerLms/
├── PowerLmsWebApi/          # Web API 层
│   ├── Controllers/         # API 控制器
│   ├── Dto/                # 数据传输对象
│   ├── Middleware/         # 中间件
│   └── Program.cs          # 程序入口
├── PowerLmsServer/         # 业务逻辑层
│   ├── Managers/           # 业务管理器
│   ├── AutoMappper/        # 对象映射配置
│   └── ProjectContent.cs   # 项目配置
├── PowerLmsData/           # 数据访问层
│   ├── 业务/               # 业务实体
│   ├── 客户资料/           # 客户实体
│   ├── 财务/               # 财务实体
│   ├── 权限/               # 权限实体
│   └── PowerLmsUserDbContext.cs  # 数据上下文
└── 诺诺网接口/             # 第三方集成文档
```

## 快速开始

### 1. 克隆代码
```bash
git clone https://github.com/ourworldcn/PowerLms.git
cd PowerLms
```

### 2. 配置数据库
编辑 `PowerLmsWebApi/appsettings.json`:
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=PowerLms;Trusted_Connection=true;TrustServerCertificate=true;"
  }
}
```

### 3. 数据库迁移
```bash
cd PowerLmsWebApi
dotnet ef database update
```

### 4. 运行项目
```bash
cd PowerLmsWebApi
dotnet run
```

访问 `https://localhost:5001/swagger` 查看 API 文档

## 核心概念

### 1. 业务对象 (PlJob)
系统的核心业务实体，代表一个完整的物流业务：
```csharp
public class PlJob : GuidKeyObjectBase
{
    public string JobNo { get; set; }           // 工作号
    public string MblNo { get; set; }           // 主单号
    public string HblNoString { get; set; }     // 分单号
    public Guid? CustomId { get; set; }         // 客户ID
    public DateTime? Etd { get; set; }          // 预计开船时间
    public DateTime? ETA { get; set; }          // 预计到港时间
    public byte JobState { get; set; }          // 业务状态
    // ... 更多属性
}
```

### 2. 客户管理 (PlCustomer)
客户信息管理：
```csharp
public class PlCustomer : GuidKeyObjectBase
{
    public string ShortName { get; set; }       // 客户简称
    public string FullName { get; set; }        // 客户全称
    public string EnglishName { get; set; }     // 英文名称
    public int CustomerType { get; set; }       // 客户类型
    public decimal CreditLimit { get; set; }    // 信用额度
    // ... 更多属性
}
```

### 3. 费用管理 (DocFee)
费用信息管理：
```csharp
public class DocFee : GuidKeyObjectBase
{
    public Guid JobId { get; set; }             // 业务ID
    public bool IsReceivable { get; set; }      // 是否应收
    public decimal Amount { get; set; }         // 金额
    public string Currency { get; set; }        // 币种
    public decimal ExchangeRate { get; set; }   // 汇率
    // ... 更多属性
}
```

## 常用开发模式

### 1. 控制器开发
```csharp
[ApiController]
[Route("api/[controller]")]
public class YourController : PlControllerBase
{
    private readonly IYourService _yourService;
    
    public YourController(IYourService yourService)
    {
        _yourService = yourService;
    }
    
    [HttpGet]
    public ActionResult<GetYourDataReturnDto> GetYourData(
        [FromQuery] GetYourDataParamsDto model)
    {
        // 实现逻辑
    }
}
```

### 2. 业务逻辑开发
```csharp
[OwAutoInjection(ServiceLifetime.Scoped)]
public class YourManager
{
    private readonly PowerLmsUserDbContext _dbContext;
    
    public YourManager(PowerLmsUserDbContext dbContext)
    {
        _dbContext = dbContext;
    }
    
    public async Task<YourResult> ProcessBusinessLogic(YourInput input)
    {
        // 实现业务逻辑
    }
}
```

### 3. 数据访问开发
```csharp
// 查询数据
var jobs = await _dbContext.PlJobs
    .Where(j => j.JobState == 2)
    .Include(j => j.Customer)
    .ToListAsync();

// 添加数据
var newJob = new PlJob
{
    JobNo = "JOB001",
    CustomId = customerId,
    CreateDateTime = DateTime.UtcNow
};
_dbContext.PlJobs.Add(newJob);
await _dbContext.SaveChangesAsync();
```

## 权限系统

### 1. 权限检查
```csharp
[HttpGet]
public ActionResult<GetDataReturnDto> GetData(GetDataParamsDto model)
{
    // 检查权限
    if (!_AuthorizationManager.CanRead<PlJob>(User))
    {
        return Forbid("无权限访问");
    }
    
    // 业务逻辑
}
```

### 2. 组织过滤
```csharp
// 自动过滤当前用户组织的数据
var query = _dbContext.PlJobs.AsQueryable();
query = _AuthorizationManager.FilterByOrganization(query, User);
```

## 常用 API 示例

### 1. 创建业务
```http
POST /api/PlJob/AddPlJob
Content-Type: application/json

{
    "jobNo": "JOB001",
    "customId": "customer-guid",
    "mblNo": "MBL123456",
    "etd": "2024-01-15T10:00:00Z",
    "goodsName": "General Cargo"
}
```

### 2. 查询业务
```http
GET /api/PlJob/GetPlJobs?startIndex=0&count=10&conditional[jobNo]=JOB001
```

### 3. 更新业务
```http
PUT /api/PlJob/ModifyPlJob
Content-Type: application/json

{
    "id": "job-guid",
    "jobState": 4,
    "eta": "2024-01-25T15:00:00Z"
}
```

## 数据库操作

### 1. 添加新迁移
```bash
dotnet ef migrations add YourMigrationName
```

### 2. 更新数据库
```bash
dotnet ef database update
```

### 3. 回滚迁移
```bash
dotnet ef database update PreviousMigrationName
```

## 配置管理

### 1. 环境配置
- `appsettings.json`: 基础配置
- `appsettings.Development.json`: 开发环境
- `appsettings.Production.json`: 生产环境

### 2. 常用配置项
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "数据库连接字符串"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information"
    }
  },
  "AllowedHosts": "*",
  "JwtSettings": {
    "SecretKey": "your-secret-key",
    "ExpirationHours": 24
  }
}
```

## 调试技巧

### 1. 日志记录
```csharp
_logger.LogInformation("Processing job {JobId}", jobId);
_logger.LogWarning("Warning message");
_logger.LogError(ex, "Error processing job {JobId}", jobId);
```

### 2. 断点调试
- 在 Visual Studio 中设置断点
- 使用 F5 开始调试
- 使用 F10/F11 进行单步调试

### 3. API 测试
使用 Postman 或 Swagger UI 测试 API 接口

## 性能优化

### 1. 数据库查询优化
```csharp
// 使用 Include 预加载关联数据
var jobs = await _dbContext.PlJobs
    .Include(j => j.Customer)
    .Include(j => j.Fees)
    .ToListAsync();

// 使用 AsNoTracking 提高查询性能
var jobs = await _dbContext.PlJobs
    .AsNoTracking()
    .ToListAsync();
```

### 2. 缓存使用
```csharp
// 使用内存缓存
var cacheKey = $"customer_{customerId}";
if (!_cache.TryGetValue(cacheKey, out PlCustomer customer))
{
    customer = await _dbContext.PlCustomers.FindAsync(customerId);
    _cache.Set(cacheKey, customer, TimeSpan.FromMinutes(30));
}
```

## 错误处理

### 1. 全局异常处理
```csharp
public class GlobalExceptionMiddleware
{
    public async Task InvokeAsync(HttpContext context, RequestDelegate next)
    {
        try
        {
            await next(context);
        }
        catch (Exception ex)
        {
            await HandleExceptionAsync(context, ex);
        }
    }
}
```

### 2. 业务异常处理
```csharp
public class BusinessException : Exception
{
    public int ErrorCode { get; }
    
    public BusinessException(int errorCode, string message) 
        : base(message)
    {
        ErrorCode = errorCode;
    }
}
```

## 部署指南

### 1. 发布应用
```bash
dotnet publish -c Release -o ./publish
```

### 2. Docker 部署
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:6.0
WORKDIR /app
COPY ./publish .
ENTRYPOINT ["dotnet", "PowerLmsWebApi.dll"]
```

### 3. IIS 部署
1. 安装 ASP.NET Core Hosting Bundle
2. 创建 IIS 应用程序
3. 配置应用程序池
4. 部署发布文件

## 常见问题

### 1. 数据库连接失败
- 检查连接字符串配置
- 确认数据库服务器可访问
- 验证用户权限

### 2. 依赖注入失败
- 检查服务注册
- 确认接口实现
- 验证生命周期设置

### 3. 权限验证失败
- 检查 JWT 令牌
- 验证用户权限
- 确认组织关系

## 参考资料

- [.NET 6 文档](https://docs.microsoft.com/zh-cn/dotnet/core/)
- [Entity Framework Core 文档](https://docs.microsoft.com/zh-cn/ef/core/)
- [ASP.NET Core 文档](https://docs.microsoft.com/zh-cn/aspnet/core/)

---

*如有问题，请联系开发团队或查看项目 Wiki 获取更多信息。*