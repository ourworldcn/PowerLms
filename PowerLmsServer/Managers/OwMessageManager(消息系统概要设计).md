# 消息系统功能与设计说明

## 基础功能
- 内部消息管理  
- 用户收件箱功能  
- 消息已读/未读标记（通过 `ReadTime` 是否为 `null` 判断）  
- 登录时展示未读消息  
- HTML 格式消息（**不考虑内容安全性**，如 XSS 防护）  
- SQL Server 数据存储  

## 技术环境
- .NET 6 框架  
- SQL Server 数据库  

## 消息特性
- 不考虑消息优先级  
- 接收者由发送者手动选择  
- 不支持附件功能  
- 不支持消息回复和转发功能  
- 过期消息永久删除（物理删除）  
- 支持自动清理过期消息（每小时执行一次）  
- 支持删除指定消息（物理永久删除）  
- 已读和未读消息有不同的保存期限配置  
- 支持批量删除和批量标记已读  
- 仅支持 HTML 格式消息  
- 消息保存期限通过注入的配置类指定  

## 技术实现
- 使用单一表设计（`OwMessage`），记录每个消息所属的人员 `Guid`  
- 消息的已读状态通过 `ReadTime` 字段是否为 `null` 判断  
- 发送操作应在后台执行  
- 避免使用 `async/await` 模式  
- 需要考虑并发，但不是高度并发场景  
- 所有功能集中在 `OwMessageManager` 服务类中  
- 使用 `Task` 实现后台发送  
- 存储到 SQL Server（不考虑分表、归档等优化）  
- 不考虑用户认证，发送函数中直接指定发送人 ID 和接收人 ID 集合  
- 不考虑已读回执  
- 定期清理直接删除数据库中记录  
- 不提供外部 API 接口，仅提供函数接口  
- 系统不触发其他事件  
- 批量发送是同步的，不会出现大量群发消息情况  
- 定时清理的触发机制使用 `System.Threading.Timer`  
- 消息发送失败直接抛出异常，不需要重试机制  

## 用户体验
- 用户可通过公开函数获取未读消息通知  
- 支持项目内已有的通用搜索  

## 数据维护
- 服务运行时每小时自动运行一次删除过期消息的 SQL 语句  
- 不考虑数据量增长过快导致的性能问题  

## 日志处理
- 记录出错的日志  
- 一般性日志仅记录服务类启动和停止  

## 权限和安全
- 用户只能访问发送给自己的消息  
- 不验证发送者权限，直接使用传入的发送者 ID  
- 不考虑 HTML 内容的安全性  

## 系统消息
- `IsSystemMessage` 字段用于标识消息是否为系统消息  
- 系统消息的发送人 ID 可以忽略  
- 系统消息与普通消息的处理逻辑相同  

## 配置
- 已读消息和未读消息的保存期限通过配置类注入  
- 配置由依赖注入系统提供  
