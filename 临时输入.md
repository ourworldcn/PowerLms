# 系统导出规则文档 (Living Document)

**版本:** 3.0
**创建日期:** 2025-08-31
**最后更新:** 2025-08-31

**说明:** 本文档是专门用于详细描述本系统中所有导出相关业务规则的“单一事实来源”。它将根据后续的会议和资料补充，持续进行更新和扩充。

---

## 模块一：结算单导入金蝶

### 1.1 收款结算单凭证生成规则

**背景**：
这是项目财务核心功能，复杂度极高。目标是将系统内的“收款结算单”转换为符合金蝶财务软件要求的会计凭证分录。

#### 1.1.1 核心概念澄清：手续费 (Handling Fee)

在处理凭证前，必须理解收款和付款场景下的“手续费”会计意义完全不同：

*   **收款单的手续费**: 指对方给我方付款时，对方银行收取的手续费。这笔费用会从我方实际收到的款项中扣除（例如，应收100美元，对方付了100，我方到账98，2美元是对方银行扣的）。这本质上是我方的一种“财务费用-换汇成本”。
*   **付款单的手续费**: 指我方给别人付款时，我方银行收取的手续费。这笔费用直接从我方的银行账户余额中扣除。

因此，二者在生成凭证时，所用的会计科目完全不同。

---

#### 1.1.2 凭证分录生成详细规则

本章节详细定义了每个导出字段的取值逻辑，是凭证生成功能的唯一实现依据。

**导出字段列表 (金蝶字段):**
`FDATE`(制单日期), `FTRANSDATE`(凭证日期), `FPeriod`(期间), `Fnum`(凭证号), `FEntryID`(分录号), `Fgroup`(凭证字), `FAcctID`(科目代码), `Fexp`(摘要), `FCLSNAME1`(核销类别), `FOBJID1`(客户财务简称), `FOBJNAME1`(客户名称), `FCLSNAME2`, `FOBJID2`, `FOBJNAME2`, `FTRANSID`, `FCyID`(币种), `FExchRate`(汇率), `FDC`(借贷方向), `FFCyAmt`(外币金额), `FDebit`(金额借方), `FCredit`(金额贷方), `FPREPARE`(制单人)

---

##### **规则 1：主营业务收款借方 (银行收款)**
*   **触发条件:** **必定生成**。
*   **业务说明:** 记录银行账户收到的款项。优先处理多笔收款，每一笔多笔收款生成一个分录。
*   **字段映射:**
    *   `FDATE` / `FTRANSDATE`: 收付款日期
    *   `FPeriod`: 收款日期的月份
    *   `Fnum`: 凭证号的序号 (e.g., `8-银-1` 中的 `1`)
    *   `FEntryID`: 同一凭证号中递增的序号
    *   `Fgroup`: 凭证号的凭证字
    *   `FAcctID`: 结算账户的科目代码 (若为多笔收款，则取该笔收款的账户科目代码)
    *   `Fexp`: 往来单位名 + "【收入】" + 收款单号
    *   `FCLSNAME1` / `FOBJID1` / `FOBJNAME1` / etc.: `【空白】`
    *   `FCyID`: 结算币种
    *   `FExchRate`: 结算单汇率
    *   `FDC`: `1` (借方)
    *   `FFCyAmt`: 收款金额 (若为多笔收款，则为该笔收款的金额)
    *   `FDebit`: 收款本位币金额
    *   `FCredit`: `0`
    *   `FPREPARE`: 配置中的制单人

---

##### **规则 2：主营业务收款贷方 (应收冲抵)**
*   **触发条件:** **必定生成**。
*   **业务说明:** 冲抵与本次收款关联的应收账款。
*   **字段映射:**
    *   `FAcctID`: **配置中**的贷方科目代码 (应收账款科目)
    *   `Fexp`: 往来单位名 + "【收入】" + 收款单号
    *   `FCLSNAME1`: `客户`
    *   `FOBJID1` / `FOBJID2`: 往来单位的客户财务编码
    *   `FOBJNAME1` / `FOBJNAME2`: 往来单位的名称
    *   `FCyID`: **本位币代码**
    *   `FExchRate`: `1`
    *   `FDC`: (贷方)
    *   `FFCyAmt`: 应收合计本位币 (计算公式: `sum(收入明细本次结算金额 * 明细原费用本位币汇率)`)
    *   `FDebit`: `0`
    *   `FCredit`: 应收合计本位币
    *   *(其他通用字段如 FDATE, Fnum 等与同一凭证保持一致)*

---

##### **规则 3：主营业务收款借方 (应付冲抵)**
*   **触发条件:** 收款单中**存在支出费用**时。
*   **业务说明:** 在一笔收款业务中，同时冲销付给该客户的款项。
*   **字段映射:**
    *   `FAcctID`: **配置中**的贷方科目代码 (应付账款科目)
    *   `Fexp`: 往来单位名 + "【收入】" + 收款单号
    *   `FCLSNAME1`: `客户`
    *   `FOBJID1` / `FOBJID2`: 往来单位的客户财务编码
    *   `FOBJNAME1` / `FOBJNAME2`: 往来单位的名称
    *   `FCyID`: **本位币代码**
    *   `FExchRate`: `1`
    *   `FDC`: (借方)
    *   `FFCyAmt`: 应付合计本位币 (计算公式: `sum(支出明细本次结算金额 * 明细原费用本位币汇率)`)
    *   `FDebit`: 应付合计本位币
    *   `FCredit`: `0`
    *   *(其他通用字段如 FDATE, Fnum 等与同一凭证保持一致)*

---

##### **规则 4：主营业务收款预收贷方 (预收款)**
*   **触发条件:** `预收金额 != 0`
*   **业务说明:** 客户支付的金额大于应收金额，差额部分计入预收款。
*   **字段映射:**
    *   `FAcctID`: **配置中**的贷方科目代码 (预收款科目)
    *   `Fexp`: 往来单位名 + "【收入】" + 收款单号
    *   `FCLSNAME1`: `客户`
    *   `FOBJID1` / `FOBJID2`: 往来单位的客户财务编码
    *   `FOBJNAME1` / `FOBJNAME2`: 往来单位的名称
    *   `FCyID`: 结算币种
    *   `FExchRate`: 结算单汇率
    *   `FDC`: (贷方)
    *   `FFCyAmt`: 预收金额
    *   `FDebit`: `0`
    *   `FCredit`: 预收本位币金额
    *   *(其他通用字段如 FDATE, Fnum 等与同一凭证保持一致)*

---

##### **规则 5：主营业务收款汇兑损益借/贷方 (汇兑损益)**
*   **触发条件:** `汇兑损益 != 0`
*   **业务说明:** 因汇率波动产生的损益。金额可正可负，决定借贷方向。
*   **字段映射:**
    *   `FAcctID`: **配置中**的贷方科目代码 (汇兑损益科目)
    *   `Fexp`: 往来单位名 + "【收入】" + 收款单号
    *   `FCyID`: **本位币代码**
    *   `FExchRate`: `1`
    *   `FDC`: 根据汇兑损益金额正负决定 (借或贷)
    *   `FFCyAmt`: 汇兑损益金额
    *   `FDebit`: 若为正，填入此字段
    *   `FCredit`: 若为负，取绝对值填入此字段
    *   *(其他通用字段如 FDATE, Fnum 等与同一凭证保持一致)*

---

##### **规则 6：主营业务收款手续费借方 (手续费)**
*   **触发条件:** `手续费 != 0` 或 `手续费本位币 != 0`
*   **业务说明:** 记录银行收取的手续费。
*   **字段映射:**
    *   `FAcctID`: **配置中**的贷方科目代码 (财务费用-手续费科目)
    *   `Fexp`: 往来单位名 + "【收入】" + 收款单号
    *   `FCyID`:
        *   **Case 1 (仅本位币):** `本位币代码`
        *   **Case 2 (原币+本位币):** `结算币种`
    *   `FExchRate`:
        *   **Case 1 (仅本位币):** `1`
        *   **Case 2 (原币+本位币):** `结算汇率`
    *   `FDC`: (借方)
    *   `FFCyAmt`:
        *   **Case 1 (仅本位币):** `手续费本位币`
        *   **Case 2 (原币+本位币):** `手续费金额`
    *   `FDebit`: 手续费本位币
    *   `FCredit`: `0`
    *   *(其他通用字段如 FDATE, Fnum 等与同一凭证保持一致)*

---

##### **规则 7：主营业务收款预收冲应收借方 (冲账)**
*   **触发条件:** `预收冲应收 != 0`
*   **业务说明:** 使用客户的预收款来抵扣本次的应收账款。
*   **字段映射:**
    *   `FAcctID`: **配置中**的贷方科目代码 (预收款科目)
    *   `Fexp`: 往来单位名 + "【收入】" + 收款单号
    *   `FCLSNAME1`: `客户`
    *   `FOBJID1` / `FOBJID2`: 往来单位的客户财务编码
    *   `FOBJNAME1` / `FOBJNAME2`: 往来单位的名称
    *   `FCyID`: 结算币种
    *   `FExchRate`: 结算单汇率
    *   `FDC`: (借方)
    *   `FFCyAmt`: 预收冲应收
    *   `FDebit`: 预收冲应收 * 结算单汇率
    *   `FCredit`: `0`
    *   *(其他通用字段如 FDATE, Fnum 等与同一凭证保持一致)*

---

*（文档待续...）*