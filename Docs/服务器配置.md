# PowerLms服务器配置与部署指南

## 📋 **配置概览**

PowerLms是基于.NET 6的企业级物流货代管理系统，需要以下服务器环境：

- **应用服务器**: 运行PowerLmsWebApi (.NET 6)
- **数据库服务器**: SQL Server 2017+ 
- **文件存储**: 支持OwFileService的文件存储
- **可选**: Redis缓存服务器（推荐用于生产环境）

---

## 🔧 **通用网络与端口配置**

### PowerLms系统端口
```
HTTP API服务:
├── TCP 80/443    - Web API服务 (HTTP/HTTPS)
├── TCP 5000      - 开发环境默认端口
├── TCP 5001      - 开发环境HTTPS端口
└── TCP 1433      - SQL Server数据库连接

文件服务端口:
├── TCP 20021     - FTP文件传输
├── TCP 20449     - 资源服务器
└── TCP 20443/20444 - 自定义服务端口

通信协议端口:
├── UDP 20088/20089 - 实时通信协议
└── UDP 20087     - 测试环境额外端口
```

### 防火墙规则
```bash
# 入站规则
TCP: 80, 443, 1433, 20021, 20443, 20444, 3389
UDP: 20087, 20088, 20089

# 内网通信 (服务器间)
TCP: 1433 (数据库访问)
TCP: 6379 (Redis, 可选)
```

---

## 🖥️ **开发与测试环境**

### 单机部署配置
```
最低配置:
├── CPU: 4核 2.2 GHz+
├── 内存: 16 GB
├── 硬盘: SSD ≥ 100 GB (系统 + 应用 + 数据库)
│   ├── 系统盘: 50 GB
│   ├── 应用目录: 20 GB  
│   └── 数据库文件: 30 GB+
├── 网络: ≥ 10 MB/s
└── 操作系统: Windows Server 2019+ (中文版)

软件要求:
├── .NET 6 Runtime (ASP.NET Core)
├── SQL Server 2017+ (Developer/Standard版)
├── IIS 10+ 或 Kestrel直接部署
└── Visual C++ Redistributable (依赖组件)
```

### 开发环境特殊需求
```
开发工具支持:
├── Visual Studio 2022 或 VS Code
├── SQL Server Management Studio
├── 可选: Docker Desktop (容器化部署)
└── 可选: Redis Desktop Manager

调试端口:
├── TCP 5000/5001 - Kestrel开发服务器
├── TCP 19000+    - 调试端口范围
└── UDP 20087     - 开发环境测试协议
```

---

## 🏭 **生产环境配置**

### 应用服务器 (PowerLmsWebApi)
```
推荐配置:
├── CPU: 8核 2.5 GHz+ (Intel Xeon 或 AMD EPYC)
├── 内存: 32 GB DDR4
├── 硬盘: 
│   ├── 系统盘: 100 GB SSD
│   ├── 应用盘: 50 GB SSD
│   ├── 日志盘: 100 GB SSD
│   └── 文件存储: 500 GB+ SSD (OwFileService)
├── 网络: ≥ 100 MB/s 带宽
└── 操作系统: Windows Server 2019/2022 (中文版)

负载均衡配置 (可选):
├── 支持多实例部署
├── Session状态外置 (Redis/SQL Server)
├── 文件存储共享 (NFS/Azure Files)
└── 健康检查端点: /health
```

### 数据库服务器 (SQL Server)
```
推荐配置:
├── CPU: 8核 3.0 GHz+ (数据库优化)
├── 内存: 64 GB DDR4 (缓存池)
├── 硬盘配置:
│   ├── 系统盘: 100 GB SSD
│   ├── 数据库文件: 500 GB+ NVMe SSD
│   │   ├── 主数据文件 (.mdf): 300 GB+
│   │   └── 日志文件 (.ldf): 200 GB+
│   ├── 备份盘: 1 TB+ (机械硬盘可接受)
│   └── TempDB: 100 GB SSD (独立盘)
├── 网络: 千兆内网 + 10 MB/s外网
└── 操作系统: Windows Server 2019/2022

性能要求:
├── SSD IOPS: ≥ 3000 (数据盘)
├── 吞吐量: ≥ 500 MB/s
├── 数据库版本: SQL Server 2017 Enterprise+
├── 权限: sysadmin (部署) + db_owner (运行)
└── 备份策略: 每日全量 + 每小时增量
```

### 文件存储服务器
```
专用文件服务器:
├── CPU: 4核 2.2 GHz+
├── 内存: 16 GB
├── 硬盘:
│   ├── 系统盘: 100 GB SSD
│   └── 存储盘: 2 TB+ (根据业务量)
├── 网络: 千兆内网连接
└── 服务: FTP + 自定义文件API

或使用云存储:
├── Azure Blob Storage
├── AWS S3
├── 阿里云OSS
└── 腾讯云COS
```

---

## ☁️ **云平台部署建议**

### Azure部署
```
推荐资源:
├── App Service: Standard S2+ (应用)
├── SQL Database: S2+ (数据库)
├── Storage Account: Standard (文件)
├── Application Insights (监控)
└── Azure CDN (静态资源)

配置示例:
├── App Service Plan: 2核4GB × 2实例
├── SQL Database: 100 DTU (弹性池)
├── Blob Storage: 热存储层
└── Virtual Network: 内网通信
```

### AWS部署  
```
推荐资源:
├── EC2: t3.large+ (应用)
├── RDS SQL Server: db.t3.large+ (数据库)
├── S3: Standard (文件)
├── CloudWatch (监控)
└── CloudFront (CDN)
```

### 阿里云部署
```
推荐资源:
├── ECS: ecs.c6.large+ (应用)
├── RDS SQL Server: mssql.x4.large+ (数据库)  
├── OSS: 标准存储 (文件)
├── 云监控 (监控)
└── CDN (静态资源)
```

---

## 📊 **性能基准与监控**

### 性能指标
```
应用服务器:
├── CPU使用率: < 70%
├── 内存使用率: < 80%
├── 响应时间: < 500ms (P95)
├── 吞吐量: > 1000 RPS
└── 错误率: < 0.1%

数据库服务器:
├── CPU使用率: < 80%
├── 内存使用率: < 90%
├── 磁盘队列长度: < 10
├── 阻塞进程: < 5个
└── 平均查询时间: < 100ms
```

### 监控配置
```
系统监控:
├── Windows Performance Counter
├── SQL Server Performance Monitor
├── IIS日志分析
└── 自定义业务指标

日志收集:
├── Serilog → Elasticsearch
├── Application Insights
├── SQL Server错误日志
└── 审计日志(登录/权限变更)
```

---

## 🔒 **安全配置**

### 系统安全
```
操作系统:
├── 定期Windows更新
├── 禁用不必要的服务
├── 配置本地安全策略
├── 启用Windows Defender
└── 配置审计策略

网络安全:
├── 防火墙规则最小化原则
├── 禁用不安全的协议 (SMBv1等)
├── 使用VPN访问内网
├── SSL/TLS加密通信
└── 定期安全扫描
```

### 数据库安全
```
SQL Server安全:
├── Windows身份验证优先
├── 最小权限原则
├── 启用透明数据加密 (TDE)
├── 定期备份测试
├── 启用审计功能
└── 数据库防火墙规则
```

### 应用安全
```
PowerLms应用:
├── HTTPS强制重定向
├── 安全响应头配置
├── 输入验证和防注入
├── 敏感数据加密存储
├── JWT Token安全配置
└── 定期依赖项更新
```

---

## 📋 **部署检查清单**

### 部署前检查
```
□ 硬件资源满足最低要求
□ 操作系统版本和更新状态
□ .NET 6 Runtime安装
□ SQL Server安装和配置
□ 网络端口开放和测试
□ 防火墙规则配置
□ SSL证书准备 (生产环境)
□ 数据库连接字符串配置
□ 文件存储目录权限
□ 备份策略制定
```

### 部署后验证
```
□ 应用启动成功
□ 数据库连接正常
□ API接口响应正常
□ 文件上传下载功能
□ 用户登录和权限验证
□ 工作流引擎功能
□ 外部系统集成 (金蝶/诺诺)
□ 性能基准测试
□ 监控指标收集
□ 备份恢复测试
```

---

## 🚀 **扩展性规划**

### 水平扩展
```
应用层扩展:
├── 多实例负载均衡
├── Session状态外置
├── 静态文件CDN
└── 微服务拆分 (长期)

数据层扩展:
├── 读写分离
├── 分库分表 (按租户)
├── 数据归档策略
└── 缓存层引入 (Redis)
```

### 容器化部署 (可选)
```
Docker配置:
├── PowerLmsWebApi容器
├── SQL Server容器 (开发环境)
├── Redis缓存容器
└── Docker Compose编排

Kubernetes部署:
├── Deployment + Service
├── ConfigMap + Secret
├── PersistentVolume (文件存储)
├── Ingress (负载均衡)
└── HPA (自动扩缩容)
```

---

## 📞 **技术支持与维护**

### 运维联系信息
```
技术支持:
├── 开发团队: [联系方式]
├── 系统管理员: [联系方式]
├── 数据库DBA: [联系方式]
└── 网络管理员: [联系方式]

紧急联系:
├── 24小时值班电话: [电话]
├── 技术支持邮箱: [邮箱]
└── 在线支持系统: [URL]
```

### 维护计划
```
日常维护:
├── 每日: 系统状态检查
├── 每周: 性能报告分析
├── 每月: 安全更新安装
└── 每季度: 容量规划评估

备份策略:
├── 数据库: 每日全量备份
├── 应用配置: 每周备份
├── 文件存储: 增量备份
└── 异地备份: 每周同步
```

---

*最后更新: 2025-01-XX | PowerLms v1.0*
