# 📝 PowerLMS 变更日志

## [未发布] - 2025-01-31

### ✅ SetRoles接口保存失败问题修复

**问题描述**:
- 前端调用"给用户添角色"接口(`PUT /api/Account/SetRoles`)后，返回200成功，但数据库中角色关系未保存
- "往角色里添用户"接口(`PUT /api/Authorization/SetUsers`)工作正常

**根本原因**:
- LINQ延迟执行导致`AddRange`传入的是未执行的`IEnumerable<AccountRole>`查询表达式
- EF Core在`SaveChanges`时才执行查询，但此时上下文已关闭

**修复内容**:
1. **添加`.ToList()`确保立即执行**
   ```csharp
   var rolesToAdd = roleIdsToAdd.Select(roleId => new AccountRole { ... }).ToList();
   ```
2. **增强日志记录**
   - 添加准备添加/删除的日志
   - 添加保存成功确认日志
   - 添加无需变更时的提示日志
3. **优化空角色列表处理**
   - 允许传入空列表清空用户所有角色
   - 只在角色列表非空时验证角色存在性和所属商户
4. **改进错误提示**
   - 详细的权限错误提示
   - 数据库更新异常详细信息

**技术要点**:
- **LINQ延迟执行陷阱**: `Select`返回的是查询表达式，不是实体集合
- **EF Core Add机制**: `AddRange`需要传入已实例化的实体对象，而非查询表达式
- **缓存失效顺序**: 先保存数据库，再失效缓存

**影响接口**: `PUT /api/Account/SetRoles`

**测试建议**:
1. 给用户添加单个角色
2. 给用户添加多个角色
3. 清空用户所有角色（传入空列表）
4. 替换用户角色（删除旧的，添加新的）

### ✅ 关账功能逻辑修复

**功能变更**:
- 关账操作不再强制要求当月有业务单据
- 允许对无业务单据的月份执行关账操作
- 关账成功后自动递增账期（如202508→202509）

**业务规则调整**:
- ❌ **旧逻辑**：当月无业务单据时禁止关账
- ✅ **新逻辑**：关账与当月业务量无关，仅用于锁定会计期间
- 📌 **核心目的**：防止用户在已关账期间创建或修改单据

**关键变更**:
- 移除"当月必须有业务单据"的校验逻辑
- 保留账期顺序校验（不能跳月关账）
- 空账期关账时仍会正确推进账期

**影响接口**: `POST /api/PlJob/CloseAccountingPeriod`

### ✅ 客户资料删除限制功能

**功能变更**:
- 客户资料删除前自动检查是否被业务单据引用
- 已被工作号或结算单引用的客户无法物理删除
- 系统提示使用"设为无效"功能代替

**业务规则**:
- ✅ 允许删除：未被引用的客户资料
- ❌ 禁止删除：已被工作号、结算单引用的客户
- 📌 替代方案：使用"设为无效"状态

**错误提示示例**:
- "该客户资料已被工作号引用（作为客户），无法删除。请使用设为无效功能代替。"
- "该客户资料已被结算单引用（作为结算单位），无法删除。请使用设为无效功能代替。"

**影响接口**: `DELETE /api/Customer/RemoveCustomer`

---

### 🛡️ ModifyAccount接口健壮性改进

**问题背景**:
- 前端调用`ModifyAccount`接口时，如果用户的`OrgId`字段为`null`，会触发`NullReferenceException`空引用异常
- 缓存失效逻辑中未对`OrgId`进行空值检查

**根本原因**:
- 代码直接访问`account.OrgId.Value`，未判断`HasValue`
- 某些场景下用户的`OrgId`可能为`null`（如新创建未登录的用户、超管账户）

**修复内容**:
1. **添加空值检查**
   ```csharp
   if (account.OrgId.HasValue)
   {
       if (_OrgManager.GetMerchantIdByOrgId(account.OrgId.Value) is Guid merchantId)
       {
           _OrgManager.InvalidateOrgCaches(merchantId);
       }
   }
   ```

2. **增强异常监控**
   - 对非超管账户的`OrgId`为`null`记录警告日志
   - 便于及时发现和修复数据完整性问题
   - 超管账户允许`OrgId`为`null`（合理场景）

**技术要点**:
- **可空值类型安全**: 始终使用`HasValue`检查，避免直接访问`.Value`
- **数据完整性监控**: 通过日志发现异常数据状态
- **容错设计**: 即使数据异常也不阻断正常流程

**影响接口**: `PUT /api/Account/ModifyAccount`

**合理的null场景**:
- ✅ 新创建的用户（还未调用`SetUserInfo`登录）
- ✅ 超管账户（不需要登录到具体机构）

**异常的null场景**:
- ❌ 已登录的普通用户（应该有`OrgId`）
- ❌ 商管账户（必须关联到商户）

**日志示例**:
```
[Warning] 用户 a1b2c3d4-... (testuser) 的 OrgId 为 null，这可能导致权限和缓存失效问题
```

