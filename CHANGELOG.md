# PowerLms 变更日志

## [2025-01-27] 账期管理功能实施

### ✅ 新增功能
- **批量关闭账期**：在PlJobController中新增批量关闭账期功能
  - 预览账期关闭影响范围接口（PreviewAccountingPeriodClose）
  - 执行关闭账期操作接口（CloseAccountingPeriod）
  - 支持按机构维度批量关闭指定账期内的已审核工作号
  - 自动递增机构账期（如202501→202502）
  - 完整的权限验证和错误处理

- **字段保护机制**：在工作任务修改方法中保护关闭相关字段
  - 普通修改操作无法影响CloseDate和ClosedBy字段
  - 防止误操作导致的账期状态错乱

### 🔧 技术特性
- **业务规则验证**：只有已审核状态(JobState=8)且未关闭的工作号才能被关闭
- **事务保护**：使用数据库事务确保批量操作的原子性
- **详细日志**：记录关闭操作的详细信息，便于审计跟踪
- **状态管理**：关闭后工作号状态变更为16(已关闭)，记录关闭时间和操作人

### 📋 API接口
- `GET /PlJob/PreviewAccountingPeriodClose` - 预览账期关闭影响范围
- `POST /PlJob/CloseAccountingPeriod` - 执行关闭账期操作

### 🎯 设计决策
- **控制器归属**：关闭账期功能放在PlJobController而非机构参数控制器
  - 理由：关闭账期本质上是对工作任务的批量操作
  - 权限体系与工作任务管理保持一致
- **字段保护**：通过EF Change Tracking保护关键字段免受普通修改影响
- **数据一致性**：工作号关闭和账期递增在同一事务中执行

### ⚠️ 风险控制
- 专门权限控制（F.2.9）限制操作权限
- 强制关闭选项应对特殊业务场景
- 操作前预览功能降低误操作风险
- 完整的错误处理和回滚机制

---

## 历史变更记录

### [2025-01-27] 机构参数表基础功能
- ✅ 新增 PlOrganizationParameter 实体
- ✅ 新增 OrganizationParameterController 控制器
- ✅ 实现完整的CRUD功能
- ✅ 机构创建/删除时自动处理参数
- ✅ 独立权限控制体系
- ✅ 自动创建默认参数机制

### 业务价值
- **财务对齐**：与金蝶财务系统的月度关账流程保持一致
- **操作统一**：废除原有的单票/手动关闭，统一为账期维度的批量操作
- **权限管控**：确保只有有权限的财务人员才能执行关闭操作
- **审计友好**：完整记录每次关闭操作的详细信息

### 技术亮点
- **批量处理**：高效处理大量工作号的状态变更
- **状态机设计**：清晰的工作号状态流转逻辑
- **权限分离**：机构参数管理与账期关闭操作独立权限设计
- **事务一致性**：确保复杂业务操作的数据完整性