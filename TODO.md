# 📋 待办任务清单

## 1. 🔥 紧急任务（周末必须完成）

### 1.2 缓存机制导致的全局性系统错误
- **问题描述**: System.InvalidOperationException 不定时出现
  - ModifyCustomer 设置客户为无效时报错
  - GetAllCustomer 查询客户列表时报错
- **根源分析**: 底层缓存机制重构后，组织机构过滤存在缺陷
- **影响范围**: 全局性、间歇性错误，影响周一客户流程测试
- **负责人**: ZC@WorkGroup
- **状态**: ⏳ 进行中

---

## 2. ⚡ 高优先级任务（尽快完成）

### 2.1 费用金额回写不正确 ✅ **已完成代码修复，待测试验证**
- **问题描述**: 费用的"已申请金额"和"已结算金额"回写不稳定（翻倍/为0/正确）
- **根源分析**: 
  1. ❌ 缺少结算单明细 → 申请单明细的回写触发器
  2. ❌ 触发器中存在重复计算逻辑
  3. ⚠️ 并发更新时可能存在竞态条件
- **已完成修复**:
  1. ✅ 添加并发控制字段（`DocFee.RowVersion`、`DocFeeRequisitionItem.RowVersion`）
  2. ✅ 创建统一的计算方法：
     - `PlInvoicesItem.CalculateTotalSettledAmountForRequisitionItem()` - 计算申请单明细已结算金额
     - `DocFee.CalculateTotalRequestedAmount()` - 计算费用已申请金额
     - `DocFee.CalculateTotalSettledAmount()` - 计算费用已结算金额
  3. ✅ 重构触发器 `FeeTotalTriggerHandler`：
     - 消除重复代码（代码量减少83%）
     - 使用统一计算方法，提高可维护性
     - 正确过滤已删除实体，避免重复计算
  4. ✅ 四舍五入精度控制：确保结果精度与数据库字段一致（2位小数）
- **待完成工作**:
  1. ⏳ 创建 `PlInvoicesItemTriggerHandler` 触发器（补全结算单明细回写链路）
  2. ⏳ 编写单元测试（验证计算方法正确性）
  3. ⏳ 生成数据库迁移（添加 `RowVersion` 字段）
  4. ⏳ 编写数据修正脚本（修复历史错误数据）
  5. ⏳ 并发场景测试（验证并发控制有效性）
- **测试验证步骤**:
  ```sql
  -- 1. 创建测试费用
  -- 2. 创建申请单明细，验证 TotalRequestedAmount 正确
  -- 3. 创建结算单明细，验证 TotalSettledAmount 正确
  -- 4. 删除明细，验证金额正确减少
  -- 5. 并发场景：多用户同时操作，验证无数据覆盖
  ```
- **修复文件清单**:
  - `PowerLmsData/业务/DocFee.cs` - 添加并发控制和计算方法
  - `PowerLmsData/财务/DocFeeRequisition.cs` - 添加并发控制
  - `PowerLmsData/财务/PlInvoices.cs` - 添加计算方法
  - `PowerLmsServer/Triggers/DocBill.Triggers.cs` - 重构触发器
- **负责人**: ZC@AI协作
- **状态**: ✅ **代码修复完成** → ⏳ **待创建触发器和测试**

### 2.2 角色权限设置失败（setRoles）
- **问题描述**: setRoles 接口返回成功，但 GetAllAccountRole 查询不到设置的角色
- **代码审查结果**: ✅ **后端逻辑正确，无BUG**
- **可能原因**: 前端问题（未刷新列表/缓存）或查询条件错误
- **验证步骤**: 前端F12查看请求响应 → 直接查询数据库 → 检查前端缓存
- **负责人**: 云霄 陈 (前端排查)
- **状态**: ⏳ 待前端验证

---

## 3. 📌 普通优先级任务（按计划处理）

### 3.2 结算时金额做"余额式计算"
- **需求描述**: 结算拆分时智能填充金额
- **负责人**: 云霄 陈
- **状态**: ⏳ 待处理

### 3.3 控制申请/结算金额不超过原始金额 ✅ **已完成**
- **需求描述**: 后端校验申请/结算总额不超过费用金额
- **核心规则**: 
  1. **规则1**：已申请金额总和（按绝对值）不应超过原始费用金额（按绝对值）
  2. **规则2**：申请后的总金额不能小于0（防止过度冲红）
  3. 支持负数金额冲账场景（如政策性优惠-200元）
- **已完成功能**:
  1. ✅ 在 `DocFee` 类中添加 `ValidateRequisitionItemAmount` 方法
     - 校验公式1：|当前已申请金额 - 排除明细金额 + 新明细金额| ≤ |费用原始金额|
     - 校验公式2：(当前已申请金额 - 排除明细金额 + 新明细金额) ≥ 0
     - 支持新增和修改场景
     - 支持负数金额冲账
     - 防止过度冲红导致总金额为负
     - 并发安全：使用事务内实时查询
  2. ✅ 在控制器方法中调用校验：
     - `AddDocFeeRequisitionItem` - 新增时校验
     - `ModifyDocFeeRequisitionItem` - 修改时校验
     - `SetDocFeeRequisitionItem` - 批量设置时校验
  3. ✅ 错误处理：
     - 返回 HTTP 400 错误码
     - 提供详细的错误消息（费用原始金额、当前已申请、本次申请、合计、错误类型）
     - 记录警告日志便于排查
- **测试场景**:
  ```
  正常申请：费用630元，申请300元+300元 → ✅ 通过（600 ≤ 630 且 600 ≥ 0）
  超额申请：费用630元，申请400元+300元 → ❌ 拒绝（700 > 630）
  负金额冲账：费用2000元，申请2000元-200元 → ✅ 通过（|1800| ≤ |2000| 且 1800 ≥ 0）
  过度冲红：费用500元，申请600元-700元 → ❌ 拒绝（-100 < 0，总金额为负）
  边界情况：费用500元，申请300元-300元 → ✅ 通过（0 ≥ 0）
  并发场景：多用户同时申请 → ✅ 事务内实时校验
  ```
- **错误消息示例**:
  ```
  超额错误：申请金额超额：费用原始金额=630.00，当前已申请=400.00，本次申请=300.00，合计=700.00（绝对值超过原始金额绝对值）
  负数错误：申请后总金额不能为负：费用原始金额=500.00，当前已申请=600.00，本次申请=-700.00，合计=-100.00（过度冲红导致总金额为负）
  ```
- **修复文件清单**:
  - `PowerLmsData/业务/DocFee.cs` - 添加 `ValidateRequisitionItemAmount` 方法（包含两个校验规则）
  - `PowerLmsWebApi/Controllers/Financial/FinancialController.DocFeeRequisition.cs` - 在控制器方法中调用校验
- **负责人**: ZC@AI协作
- **完成时间**: 2025-01-29
- **状态**: ✅ **已完成，待测试验证**

### 3.4 结算单核销金额合计
- **需求描述**: 结算单核销金额、核销金额本位币合计
- **负责人**: 待定
- **状态**: ⏳ 待处理

### 3.5 后端日常费用申请单数据获取问题
- **问题描述**: 获取数据不正确，查询不到明细
- **负责人**: ZC@WorkGroup
- **状态**: ⏳ 待处理

---

## 4. 🔻 低优先级任务

### 4.1 操作案例（BBS）前端开发
- **负责人**: 云霄 陈
- **状态**: ⏳ 待处理

---

## 5. ✅ 已完成任务（后端）

### 5.1 移除缓存中实体的DbContext属性（架构改造）
- **完成时间**: 2025-01-15
- **负责人**: ZC@AI协作

### 5.2 组织树延迟加载冲突修复
- **完成时间**: 2025-01-28
- **负责人**: ZC@AI协作

### 5.3 日常费用申请单增加"申请编号"字段
- **完成时间**: 2025-01-28
- **负责人**: ZC@WorkGroup

### 5.4 商管看不见其他商管账户
- **完成时间**: 2025-01-28
- **负责人**: ZC@AI协作

### 5.5 GetAllCustomer 权限验证临时注销
- **完成时间**: 2025-01-28
- **负责人**: ZC@WorkGroup
- **备注**: 临时方案，已记录为技术债务

### 5.6 费用金额回写机制代码重构（2.1部分完成）
- **完成时间**: 2025-01-29
- **负责人**: ZC@AI协作
- **完成内容**:
  - 添加并发控制字段（`RowVersion`）
  - 创建统一计算方法（`CalculateTotalRequestedAmount` 等）
  - 重构触发器，消除重复代码
  - 代码量减少83%，提高可维护性
- **备注**: 需继续完成触发器创建和测试验证

---

## 6. 📝 测试流程清单

### 6.1 主营业务流程
建委托（工作号）→ 建费用（检查费用方案）→ 账单（检查合计金额）→ 申请单（检查合计金额、费用已申请金额、添加移除明细、余额）→ 审批流程 → 收入开发票 → 结算单（检查各合计金额、费用已结算金额）→ 结算单确认 → 工作号审核 → 关账（账期结转）→ 财务接口

### 6.2 日常费用流程
建申请 → 审批 → 拆分结算 → 结算确认 → 财务接口

### 6.3 费用金额回写测试（新增）
1. **申请金额回写测试**:
   - 创建费用 → 创建申请单明细 → 验证 `TotalRequestedAmount` 正确
   - 添加多个明细 → 验证汇总正确
   - 删除明细 → 验证金额正确减少
2. **结算金额回写测试**:
   - 创建结算单明细 → 验证申请单明细 `TotalSettledAmount` 正确
   - 验证费用 `TotalSettledAmount` 正确
   - 删除结算明细 → 验证金额正确减少
3. **并发测试**:
   - 多用户同时创建明细 → 验证无数据覆盖
   - 验证 `DbUpdateConcurrencyException` 正确抛出

---

## 7. ⚠️ 已知问题与待确认事项

### 7.1 主营业务收入审批无法选择下一审批人
- **原因**: 未配置流程
- **状态**: 待确认

---

**最后更新**: 2025-01-29
**优先级说明**: 🔥紧急 > ⚡高优先级 > 📌普通 > 🔻低优先级