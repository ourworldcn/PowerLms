# PowerLms项目待办任务

## 🎯 **当前优先级任务 (目标：9月2日前完成)**

### ✅ **已完成任务**

#### 1. 字典导入导出功能重构完成 ✅ **重大架构变更**

**会议决议执行：**
- ✅ **导出方式变更**：从一次性导出所有改为按类型分别导出
- ✅ **简单字典处理**：按分类导入导出，仅处理字典项不含分类本身
- ✅ **重复数据策略**：采用覆盖（Update）模式替代忽略模式
- ✅ **动态表发现**：从DbContext自动获取实体类型，无需硬编码

**技术实现完成：**
- ✅ **统一导入导出服务**：`ImportExportService`，采用泛型和动态发现机制
- ✅ **控制器接口优化**：3个核心接口，DTO参数封装，IFormFile独立处理
- ✅ **简单字典整体处理**：作为单一表整体导入导出，不按分类拆分
- ✅ **表注释验证**：仅支持有Comment注释的表，确保DisplayName可用
- ✅ **自然路径设计**：所有接口使用控制器自然路径，无特殊路由

**核心功能接口：**
1. **GetSupportedTables** - 获取支持的表列表（字典/客户/简单字典）
2. **Export** - 通用导出功能（参数DTO封装）
3. **Import** - 通用导入功能（IFormFile + 参数DTO）

**技术架构亮点：**
- **动态发现机制**：从`_DbContext.Model.GetEntityTypes()`获取所有实体类型
- **Comment注释驱动**：通过`entityType.GetComment()`获取中文显示名称
- **智能过滤规则**：`IsDictionaryEntity()`和`IsCustomerSubTableEntity()`自动分类
- **表名一致性**：确保Excel表名与数据库表名一一对应
- **多租户安全**：严格的OrgId隔离，导入时忽略Excel中OrgId，导出时OrgId列不显示
- **职责分离**：控制器只做校验和异常处理，业务逻辑在服务类
- **依赖注入**：服务类使用`[OwAutoInjection(ServiceLifetime.Scoped)]`自动注入

**API接口简化：**
```
GET /api/ImportExport/GetSupportedTables?token=xxx&category=dictionary     # 获取字典表列表
GET /api/ImportExport/GetSupportedTables?token=xxx&category=customer       # 获取客户子表列表  
GET /api/ImportExport/GetSupportedTables?token=xxx&category=simple         # 获取简单字典(返回SimpleDataDic)
GET /api/ImportExport/Export?token=xxx&tableType=PlCountry                 # 导出国家字典
GET /api/ImportExport/Export?token=xxx&tableType=SimpleDataDic             # 导出简单字典(整体)
POST /api/ImportExport/Import + FormData                                   # 导入功能(文件+DTO参数)
```

**创建文件：**
- ✅ PowerLmsServer/Services/ImportExportService.cs - 统一导入导出服务
- ✅ PowerLmsWebApi/Controllers/ImportExportController.cs - 简化的控制器
- ✅ PowerLmsWebApi/Controllers/ImportExportController.Dto.cs - 统一DTO定义

**修改文件：**
- ✅ PowerLmsData/基础数据/UnitConversion.cs - 添加Comment注释
- ✅ PowerLmsData/客户资料/PlCustomer.cs - 完善所有子表Comment注释

---

## 🔴 **紧急新增任务（会议决议）**

### 2. 申请单审批流程回退功能 🆕 **优先级：最高**

#### 2.1 一键回退功能开发
**业务需求：** 已审批完成的申请单发现错误时，需要撤销到初始状态以便修改

**核心逻辑：**
1. **权限控制** - 专门权限，非人人可用
2. **日志记录** - 生成当前状态快照存入系统日志
3. **清空审批流** - 删除所有已生成的审批节点
4. **状态回退** - 将主表状态改回"初始状态/未提交"
5. **保留明细** - 表头和明细数据保留，触发trigger释放关联费用
6. **消息通知** - 向审批流相关人员发送撤销通知

**适用范围：** 主营业务申请单 + OA费用申请单

**预估工期：** 2天

#### 2.2 拒绝操作逻辑优化
**技术要求：** 修改现有拒绝操作，使其同样能将单据状态回退至初始状态

**预估工期：** 0.5天

### 3. 账期管理与工作号关闭机制 🆕 **优先级：最高**

#### 3.1 机构参数表设计
**新增表结构：** 与机构一对一关联的参数表

**核心字段：**
- `current_accounting_period` - 当前账期（YYYYMM格式，只读）
- `账单抬头1`、`账单抬头2`、`账单落款` - 报表打印用

**预估工期：** 1天

#### 3.2 关闭账期功能开发
**核心逻辑：**
1. 有权限的财务操作
2. 批量关闭财务日期在当前账期内的所有工作号
3. 自动递增账期至下一月
4. 废除原有的单票/批量关闭工作号功能

**预估工期：** 1.5天

### 4. 财务日期逻辑重构 🆕 **优先级：高**

#### 4.1 财务日期联动逻辑
**新逻辑：**
- 财务日期改为只读字段
- **进口业务**：财务日期 = 到港日期
- **出口业务**：财务日期 = 开航日期
- **约束**：到港/开航日期不能选择当前月份之前的日期

**预估工期：** 1天

---

## 📋 **其他功能优化任务**

### 5. 数据导入导出功能实施评估 🆕 **优先级：中**

**背景**：需要对已完成的数据导入导出功能（第四大项）进行全面评估，识别潜在问题和改进点。

#### 5.1 功能完整性评估

**已实现功能模块：**
- ✅ **统一导入导出服务**：`ImportExportService` 支持泛型和动态发现
- ✅ **控制器接口**：3个核心RESTful接口（GetSupportedTables/Export/Import）
- ✅ **支持的数据类型**：字典表、客户资料、客户子表、简单字典
- ✅ **多租户数据隔离**：导出时OrgId不显示，导入时忽略Excel中OrgId
- ✅ **重复数据处理**：支持覆盖模式（UpdateExisting）策略

**技术架构特点：**
- ✅ **动态表发现**：通过DbContext.Model.GetEntityTypes()自动发现
- ✅ **Comment注释驱动**：基于数据库表注释获取DisplayName
- ✅ **类型安全**：强类型实体映射和属性验证
- ✅ **性能优化**：基于NPOI的高效Excel处理
- ✅ **错误处理**：完善的异常捕获和日志记录

#### 5.2 潜在问题识别

**权限验证缺失 ⚠️**：
- **位置**：控制器中存在TODO注释关于权限验证
- **风险**：任何用户都可以执行导入导出操作
- **影响**：数据安全性和访问控制不足
- **优先级**：高

**大文件处理能力 ⚠️**：
- **当前限制**：未发现对Excel文件大小的限制配置
- **潜在问题**：大量数据导入可能导致内存溢出或超时
- **建议**：添加文件大小限制和分批处理机制

**错误恢复机制 ⚠️**：
- **当前状态**：导入失败时的数据一致性保证不明确
- **风险**：部分导入失败可能导致数据不一致
- **建议**：添加事务回滚和失败恢复机制

#### 5.3 功能扩展性评估

**支持的表类型 ✅**：
```
字典类型: PlCountry, PlPort, PlCargoRoute, PlCurrency, FeesType, 
         PlExchangeRate, UnitConversion, ShippingContainersKind
客户类型: PlCustomer, PlCustomerContact, PlBusinessHeader, PlTidan, 
         CustomerBlacklist, PlLoadingAddr
简单字典: SimpleDataDic (整体处理)
```

**扩展能力评估**：
- ✅ **新表类型添加**：通过修改`IsDictionaryEntity`和`IsCustomerSubTableEntity`方法
- ✅ **业务逻辑定制**：每种表类型都有独立的处理分支
- ⚠️ **命名约定依赖**：表类型识别依赖于命名规则，存在脆弱性

#### 5.4 用户体验评估

**API设计 ✅**：
- 统一的RESTful接口设计
- 清晰的参数封装（DTO模式）
- 友好的错误信息返回

**操作便利性 ⚠️**：
- **GetSupportedTables**：一次性返回所有支持的表，用户需要筛选
- **文件格式**：仅支持Excel格式，未考虑CSV等其他格式
- **导入反馈**：仅返回成功数量，缺少详细的失败信息

#### 5.5 性能和稳定性评估

**性能特性 ✅**：
- 基于NPOI的高效Excel处理
- 批量数据库操作（SaveChanges一次调用）
- 避免N+1查询问题

**潜在性能瓶颈 ⚠️**：
- **大数据量处理**：单次导入所有数据，未采用分批策略
- **内存占用**：Excel文件完全加载到内存
- **数据库锁定**：大量数据插入/更新时可能影响其他操作

#### 5.6 代码质量评估

**架构设计 ✅**：
- 职责分离清晰（Service + Controller）
- 依赖注入正确使用
- 泛型设计提高代码复用

**代码维护性 ✅**：
- 详细的注释和文档
- 清晰的方法命名
- 统一的异常处理

**潜在改进点 ⚠️**：
- **硬编码处理**：各表类型的switch语句存在硬编码
- **配置驱动**：表类型映射可以考虑配置文件驱动
- **单元测试**：未发现相关的单元测试代码

#### 5.7 建议改进项

**立即改进（高优先级）**：
1. **权限验证实现**：完成控制器中TODO标注的权限验证逻辑
2. **文件大小限制**：添加Excel文件大小和行数限制
3. **事务管理**：确保导入操作的原子性

**中期改进（中优先级）**：
1. **分批处理**：支持大文件的分批导入机制
2. **详细日志**：增强导入过程的详细日志记录
3. **格式扩展**：考虑支持CSV等其他格式

**长期改进（低优先级）**：
1. **配置驱动**：将表类型映射改为配置文件驱动
2. **单元测试**：添加完整的单元测试覆盖
3. **异步处理**：支持异步导入导出，提升用户体验

**预估工期：** 2天（权限验证1天 + 文件限制和事务管理1天)

### 6. 费用列表申请单详情展示 🆕

**需求：** 点击费用列表的"已申请金额"显示相关申请单信息
**技术方案：** 弹窗列表展示申请单号、金额、申请人、时间

**预估工期：** 1天

### 7. OA费用申请单增加公司字段 🆕

**需求：** 主表增加"公司"字段关联客户资料表
**用途：** 支持个人费用场景下的公司选择

**预估工期：** 0.5天

### 8. 客户资料有效性管理 🆕

**需求：** 增加有效/无效状态（软删除）
**功能：** 带权限的状态切换，选择器默认只显示有效客户

**预估工期：** 1天

### 9. 客户选择器优化 🆕

**需求：** 改为弹出式窗口，显示更多字段，支持多维度搜索
**字段：** 名称、简称、财务编码、是否超期、是否超额
**搜索：** 按名称、简称、财务编码模糊搜索

**预估工期：** 2天

---

## 📊 **任务优先级排序（更新后）**

| 任务 | 优先级 | 状态 | 预估工期 | 目标完成时间 |
|------|--------|------|----------|-------------|
| 申请单一键回退功能 | 🔴 最高 | 新增 | 2.5天 | 8月21日 |
| 账期管理机制 | 🔴 最高 | 新增 | 2.5天 | 8月23日 |
| 财务日期逻辑重构 | 🔴 高 | 新增 | 1天 | 8月24日 |
| 权限验证逻辑实现 | 🔴 高 | 进行中 | 0.5天 | 8月24日 |
| 数据导入导出功能评估改进 | 🟡 中 | 新增 | 2天 | 8月26日 |
| 费用列表申请单详情 | 🟡 中 | 新增 | 1天 | 8月27日 |
| OA申请单公司字段 | 🟡 中 | 新增 | 0.5天 | 8月27日 |
| 客户资料有效性管理 | 🟡 中 | 新增 | 1天 | 8月28日 |
| 客户选择器优化 | 🟡 中 | 新增 | 2天 | 8月30日 |

**总计剩余工期：** 13个工作日  
**目标完成时间：** 2025年9月2日  
**风险评估：** 中等 - 核心流程变更较多，需紧密配合

---

## 🔧 **技术债务和注意事项**

### 权限验证待完善
- **位置**：所有导入导出接口中的TODO注释
- **要求**：实现"搜索权限文件，如果有叶子权限符合要求就使用，如果没有就不进行权限验证"的逻辑
- **影响**：影响导入导出功能的安全性

### 导入导出功能技术债务 🆕
- **大文件处理**：缺少文件大小限制，可能导致内存溢出
- **事务管理**：导入失败时的数据一致性保证不足
- **性能优化**：大数据量导入时缺少分批处理机制
- **错误恢复**：缺少导入失败后的数据回滚机制