# 📋 PowerLMS 后端待办任务

## 🔴 紧急任务（核心流程阻塞）

### 1️⃣ 基础资料覆盖导入失败 [BUG]
**负责人**: ZC@WorkGroup  
**优先级**: P0 - 紧急  
**问题描述**: 用户选择"覆盖"方式导入基础资料时，后端未执行删除已存在记录的逻辑，导致数据重复（从2条变3条、4条）。

**技术细节**:
- 前端传参 `isOverride = true` 正确
- 后端应实现"删除已存在的记录"逻辑
- 当前表现为新增而非覆盖

**修复范围**:
- 检查 ImportExportService 中基础资料导入方法
- 定位覆盖逻辑的实现位置
- 修复删除+新增的事务处理

**测试验证**:
- 导入相同数据两次，验证记录数量不变
- 验证覆盖后数据确实更新

---

### 2️⃣ 已申请金额回写失败 [BUG]
**负责人**: ZC@WorkGroup
**优先级**: P0 - 紧急  
**问题描述**: 提交费用申请后，工作号中对应费用的"已申请金额"字段未被正确回写，时而为0，时而正确，表现不稳定。

**业务逻辑**:
- 采用持久化回写方式（非实时计算）
- 便于查询和核对，避免列表接口性能开销
- 新增/修改申请单时触发回写

**技术实现**:
- 定位费用实体的"已申请金额"字段
- 检查申请单保存时的触发逻辑
- 排查事务提交时机问题
- 考虑并发场景下的数据一致性

**修复范围**:
- 申请单新增时的回写逻辑
- 申请单修改时的回写逻辑
- 申请单删除时的回写逻辑（需要回退金额）
- 审批驳回时的回写逻辑

**测试验证**:
- 创建申请单，验证费用的已申请金额正确更新
- 修改申请单明细，验证金额重新计算
- 删除申请单，验证金额正确回退

---

### 3️⃣ 申请单明细偶发性加载失败 [BUG]
**负责人**: ZC@WorkGroup (核心逻辑)  
**优先级**: P0 - 紧急  
**问题描述**: 打开申请单详情页时，费用明细列表时而显示正常，时而为空。前端反复进出详情页，问题随机复现。后端API有时返回数据数组，有时返回空数组[]，但HTTP状态均为200。

**关联现象**:
- 申请单#70状态显示"已完成"，但审批流程图显示仍有节点挂起
- 状态不一致可能影响数据查询

**排查方向**:
- 检查明细查询的SQL逻辑和关联条件
- 排查是否存在缓存问题
- 检查多租户数据隔离是否正确
- 验证审批状态与明细可见性的关联逻辑
- 排查并发访问导致的数据脏读问题

**修复范围**:
- 申请单明细查询接口
- 数据访问层的缓存策略
- 审批流程状态与数据可见性的关联

**测试验证**:
- 反复打开同一申请单详情，验证明细稳定显示
- 在不同审批状态下测试明细加载
- 并发测试多用户同时查看

---

### 4️⃣ 超额申请/结算校验缺失 [功能增强]
**负责人**: ZC@WorkGroup  
**优先级**: P0 - 紧急  
**问题描述**: 系统未在后端实施严格的金额校验，可能导致申请/结算金额超过原始费用金额。

**业务规则**:
- 针对同一笔费用的所有申请明细金额求和（无论正负），其绝对值不能超过该费用原始金额的绝对值
- 必须支持负数金额（如政策性优惠冲账场景）
- 使用绝对值进行比较

**技术实现**:
- 在申请单明细保存时增加校验逻辑
- 查询该费用关联的所有申请明细并求和
- 比较 |已申请总额 + 本次申请额| <= |费用原始金额|
- 校验失败时返回明确的业务异常

**修复范围**:
- 申请单明细保存方法
- 结算单明细保存方法（如果存在）
- 添加事务级别的并发控制

**测试验证**:
- 对630元费用，申请600元后再申请50元，应被拒绝
- 对2000元费用，添加-200元负数冲账后，可申请1800元
- 并发提交多个申请，验证总额不会超限

---

### 5️⃣ 提交时找不到审批模板/下一节点 [BUG]
**负责人**: ZC@WorkGroup  
**优先级**: P1 - 高  
**问题描述**: 新建申请并提交时，系统报错提示找不到对应的审批流程模板（如 OA_exchange_income），导致无法发起审批。

**可能原因**:
- 前端未正确传递申请类型参数
- 后端模板匹配逻辑有误
- 审批流程模板配置缺失或命名不匹配
- 多租户环境下模板隔离问题

**排查方向**:
- 检查申请单提交接口接收的参数
- 验证审批模板查询逻辑
- 确认模板命名规范和配置完整性
- 检查日志中的详细错误信息

**修复范围**:
- 申请单提交方法
- 审批流程模板匹配逻辑
- 可能需要补充默认模板配置

---

## 🟡 计划任务

### 📊 数据配置问题
**负责人**: 永昌 石  
**问题描述**: "会计科目"中关联的"凭证字"基础数据缺失，导致查询时报错找不到Voucher ACC Catalog。

**解决方案**: 手动补全或修正导入文件，属于数据配置问题而非代码问题。

---

## 📝 备注

### 技术约束
- 禁止使用异步模式
- EF Core实体不使用record类型
- 事务处理需确保数据一致性
- 多租户数据隔离必须严格执行

### 暂缓任务
- UI/UX布局定制化改造（待核心流程稳定后处理）
- 新功能模块（保险单、检验检疫等）

### 协作约定
- 陈云霄保持测试环境数据不变，便于调试审批流相关问题
- 修复完成后通知永昌石进行业务验证

---

**最后更新**: 2025-11-10（基于会议纪要生成）
