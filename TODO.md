# 📋 PowerLms 待办任务清单

## 🔴 1. 紧急任务（最高优先级）

### 1.1 架构清理
- [ ] **空运接口架构整理** (1天) 🔥
  - 问题：PlJobController.EaDoc.cs 与 PlAirborneController 存在功能重复
  - 方案：统一到 PlAirborneController，删除 PlJobController 中的空运相关代码
  - 影响：维护成本高，容易产生路由冲突

### 1.2 Bug修复
- [x] **费用过滤Bug修复** (0.5天) ✅ **已完成 2025-02-06**
  - 问题：`GetDocFeeRequisitionItem` 接口中 `fee_id` 参数过滤未生效
  - 文件：`DocFeeRequisitionManager.cs` 第86行
  - 修复：将bill表的内连接改为左连接
  - 影响：费用反查申请单明细功能已恢复，无账单关联的费用数据不再丢失
  - 测试：✅ 编译通过，待集成测试验证

---

## 🟡 2. 功能开发（中优先级）

### 2.1 基础资料功能
- [x] **基础资料导入覆盖验证** ✅ **已确认正常 2025-02-06**
  - 验证结果：`OwDataUnit.BulkInsert` 按主键匹配，逻辑正确
  - 状态：无需修改，功能正常工作
  - 位置：`ImportExportService.cs` 第766-971行
  - 技术说明：`OwDataUnit.BulkInsert` 的 `ignoreExisting` 参数按主键（Id）判断重复，每次导入都生成新Id，因此不会触发重复检测。如需按Code覆盖，应使用自定义键重载方法。

- [x] **汇率导入功能处理** (0.3天) ✅ **已完成 2025-02-06**
  - 问题：缺少重复数据检测，会导致重复插入
  - 修复：添加按业务条件（业务类型+币种+日期）的重复检测逻辑
  - 文件：`AdminController.Base.cs` 第522-603行
  - 影响：防止重复导入相同汇率，提升数据质量
  - 测试：✅ 编译通过，待集成测试验证

### 2.2 用户与权限管理
- [x] **新建用户机构必填处理** (0.3天) ✅ **已完成 2025-02-06**
  - 问题：新建用户时不选择所属机构，用户会"消失"
  - 修复：商管创建普通用户时未指定机构ID，自动归属到当前商户
  - 文件：`AccountController.cs` 第376-447行
  - 根本原因：用户没有 `AccountPlOrganizations` 记录时，在商管查询用户列表时会被过滤掉
  - 影响：防止用户"消失"，确保所有用户都能被商管找到并管理
  - 测试：✅ 编译通过，待集成测试验证

- [x] **账户检索增加管理员选项** ✅ **已确认正常 2025-02-06**
  - 验证结果：功能已实现，支持 `IsAdmin` 和 `IsMerchantAdmin` 参数筛选
  - 状态：无需修改，当前功能满足需求
  - 位置：`AccountController.cs` 第166-188行
  - 技术说明：使用位掩码操作正确实现了管理员筛选，支持按管理员状态排序

### 2.3 本公司信息维护功能
- [ ] **创建"本公司信息"功能模块** (2天) 🆕
  - **背景**：解决新建机构时无法选择"本位币"的"鸡生蛋、蛋生鸡"问题
  - **功能设计**：
    - 创建独立的机构信息编辑接口
    - 允许财务等特定角色编辑本机构详细信息
    - 支持字段：法人代表、营业执照号、开户行、财务设置、本位币等
    - 锁定字段："显示名称"、"全名"、"架构类型"（由超管设定，不可修改）
  - **接口设计**：
    - `GET /api/Organization/GetCurrentOrganizationInfo` - 获取当前机构信息
    - `PUT /api/Organization/UpdateCurrentOrganizationInfo` - 更新当前机构信息
  - **权限控制**：授权给财务等特定角色
  - **数据验证**：确保必填字段完整性

### 2.4 工作号功能
- [x] **复制工作号时排除财务日期** (0.1天) ✅ **已完成 2025-02-06**
  - 需求：复制工作号时，不应复制"财务日期"
  - 修复：在 `CopyJob` 方法中强制清空 `AccountDate` 字段
  - 文件：`PlJobController.cs` 第832-1070行（`CopyJob` 方法）
  - 根本原因：财务日期应由前端根据新工作号的开航/到港日期重新计算，复制旧值会导致数据不一致
  - 影响：防止复制工作号时携带错误的财务日期，确保财务计算准确性
  - 测试：✅ 编译通过，待集成测试验证

### 2.5 权限缓存优化
- [ ] **权限缓存问题持续监控** (持续跟进)
  - 状态：后端基础代码已修改完毕
  - 后续：如果再出现权限不生效的问题，需要记录：
    - 问题现象
    - 发生时间
    - 闲置时长
  - 目的：判断是应用代码问题还是缓存问题

---

## 🟢 3. 功能增强（低优先级）

### 3.1 客户资料管理
- [ ] **客户有效性管理** (1.5天)
  - 需求：增加`IsActive`字段，实现客户软删除/停用功能
  - 接口：`POST /api/Customer/ToggleActiveStatus`
  - 注意：需要处理已选了无效客户的旧数据

### 3.2 申请单功能
- [ ] **OA申请单公司字段验证** (0.5天)
  - 需求：验证OA费用申请单的`CustomerId`字段集成
  - 状态：CustomerId字段已存在，需确认数据库迁移和前端对接

- [ ] **费用列表申请单详情接口** (1天)
  - 需求：点击"已申请金额"显示该费用在哪些申请单中被引用
  - 接口：`GET /api/Financial/GetFeeRequisitionDetails?feeId={id}`

- [ ] **查看所有申请单权限** (0.5天)
  - 需求：财务角色查看所有申请单，不受申请人限制
  - 状态：权限已添加，需后端接口支持

### 3.3 客户选择器优化
- [ ] **客户选择器查询优化** (1天)
  - 需求：弹窗式选择器，支持多维度搜索、分页、排序
  - 接口：`GET /api/Customer/GetCustomersForSelector`

### 3.4 科目设置
- [ ] **科目设置快捷输入** (0.5天)
  - 需求："凭证字"和"核算类别"字段支持下拉选择
  - 方案：类似银行账号快捷输入，数据源来自基础字典

---

## 🟠 4. 金蝶导出重构 (待规则文件) - 预估5天

### 4.1 金蝶凭证分录逻辑重构
- [ ] **等待Excel规则文件** ⏸️
  - 背景：当前逻辑无法处理第三方付款和复杂费用拆分场景
  - 核心变更：
 - 银行分录拆分：多笔收付款独立分录
    - 应收/应付拆分：按国外客户、国内客户、关税三种情况拆分
  - 实施要求：数据驱动设计，引入$(实体名.字段名)变量替换机制
  - 当前状态：等待永昌石完成Excel规则文件
  - 下一步：专题会议评审规则文件后开发

---

## 📊 5. 测试与验证任务

### 5.1 待验证功能
- [ ] **港口导入功能验证** 
  - 状态：已修复港口类别识别问题，待测试验证

- [ ] **申请单编辑状态测试**
  - 状态：已修复，但涉及多种状态判断，需全面测试
  - 负责人：石永昌（测试）

### 5.2 偶发问题跟踪
- [ ] **新增账单合计金额显示问题**
  - 问题：新增账单时，底部合计金额有时显示，有时不显示
  - 状态：偶发问题，待石永昌复现并提供详细步骤

- [ ] **备用方案生成费用名称丢失**
  - 问题：从备用方案生成费用时，费用名称丢失，只显示编号
  - 负责人：陈云霄排查（可能是前端问题）

---

## 🔧 6. 开发规范检查清单

### 新功能开发必检项
- [ ] 文件操作 → OwFileService
- [ ] 审批流程 → OwWfManager
- [ ] 权限控制 → AuthorizationManager
- [ ] 组织管理 → OrgManager
- [ ] 系统配置 → DataDicManager
- [ ] 消息通知 → OwMessageManager
- [ ] Excel处理 → OwDataUnit + OwNpoiUnit
- [ ] 分次收付 → ActualFinancialTransaction
- [ ] 缓存管理 → OwCacheExtensions
- [ ] 权限验证
- [ ] 多租户隔离
- [ ] 向后兼容
- [ ] 单元测试

---

## 📝 备注说明

### 优先级定义
- 🔴 **紧急任务**：阻塞性Bug或架构问题，必须立即处理
- 🟡 **功能开发**：正常的功能开发和优化，按计划推进
- 🟢 **功能增强**：用户体验优化，可适当延后
- 🟠 **重构任务**：大型重构，需要充分准备和评审

### 任务状态标识
- [ ] 待处理
- [x] 已完成
- 🔄 进行中
- ⏸️ 暂缓
- 🆕 新增需求

### 协作说明
- 后端负责人：ZC@WorkGroup
- 前端负责人：陈云霄
- 测试负责人：石永昌
- 产品经理：石永昌

### 更新日志
- 2025-02-06：从会议纪要(2024-07-26)中提取后端任务并整理
