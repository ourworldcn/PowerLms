# 📋 待办任务清单

## 1. 🔥 紧急任务（周末必须完成）

### 1.1 ✅ 移除缓存中实体的DbContext属性（架构改造）
- **问题描述**: Account和PlMerchant等实体在缓存中持有DbContext属性,导致多DbContext冲突
- **根源分析**: 缓存的对象不应持有DbContext,应该是纯数据对象(POCO)
- **解决方案**: 
  - 移除Account.DbContext属性
  - 移除PlMerchant.DbContext属性
  - 改造AccountManager的加载/缓存/保存逻辑
  - 改造AccountController的修改方法使用范围DbContext
  - 修复RoleManager和PermissionManager中的DbContext使用
- **影响范围**: 
  - ✅ Account.cs - 移除DbContext属性
  - ✅ PlMerchant.cs - 移除DbContext属性
  - ✅ AccountManager.cs - LoadById/Loaded/UpdateToken/SaveAccount改造
  - ✅ AccountController.cs - ModifyPwd/ResetPwd/Nop/SetUserInfo改造
  - ✅ OwContext.cs - Nop/SaveChanges改造
  - ✅ RoleManager.cs - 修复DbContext使用
  - ✅ PermissionManager.cs - 修复DbContext使用
- **负责人**: ZC@AI协作
- **状态**: ✅ 已完成
- **完成时间**: 2025-01-15
- **备注**: 编译成功,遵循"只读缓存+范围DbContext修改"模式

### 1.2 缓存机制导致的全局性系统错误
- **问题描述**: System.InvalidOperationException 不定时出现
  - ModifyCustomer 设置客户为无效时报错
  - GetAllCustomer 查询客户列表时报错
- **根源分析**: 底层缓存机制重构后，组织机构过滤存在缺陷
- **影响范围**: 全局性、间歇性错误，影响周一客户流程测试
- **负责人**: ZC@WorkGroup
- **状态**: ⏳ 进行中

---

## 2. ⚡ 高优先级任务（尽快完成）

### 2.1 费用金额回写不正确
- **问题描述**: 费用的"已申请金额"和"已结算金额"回写不稳定（翻倍/为0/正确）
- **根源分析**: 数据库触发器不稳定，第三方框架移除后引用关系存在问题
- **解决方案**: 废弃触发器，改为代码层面处理回写逻辑
- **负责人**: ZC@WorkGroup
- **状态**: ⏳ 待处理

### 2.2 角色权限设置失败（setRoles）
- **问题描述**: setRoles 接口返回成功，但 GetAllAccountRole 查询不到设置的角色
- **负责人**: ZC@WorkGroup / 云霄 陈
- **状态**: ⏳ 待处理

### 2.3 日常费用申请单增加"申请编号"字段
- **需求描述**: 增加唯一申请编号，区分同一人多笔相同金额的申请
- **实现要点**:
  - 后端: 增加申请编号字段，新增编码规则类型
  - 前端: 列表/查询/详情页面显示（放在最前面）
- **负责人**: ZC@WorkGroup (后端) / 云霄 陈 (前端)
- **状态**: ✅ 已完成 (后端) | ⏳ 待实施 (前端)
- **完成时间**: 2025-01-28
- **实现说明**: 
  - 后端已在 `OaExpenseRequisition` 表增加 `ApplicationNumber` 字段
  - 编号由前端调用 `POST /api/JobNumber/GeneratedOtherNumber` 接口生成
  - 需在"其他编码规则"中配置规则（Code: `OAEXPENSE_APP_NO`）

---

## 3. 📌 普通优先级任务（按计划处理）

### 3.1 商管看不见其他商管账户
- **问题描述**: 商管登录后只能看到自己，看不到该商户下其他商管账户
- **原因分析**: 查询逻辑错误使用 ORG ID 过滤，商管无 ORG ID
- **解决方案**: 商管应能看到本商户下所有账户（包括其他商管）
- **负责人**: ZC@WorkGroup
- **状态**: ⏳ 待处理

### 3.2 结算时金额做"余额式计算"
- **需求描述**: 结算拆分时智能填充金额
  - 第一行自动填充总额（如660元）
  - 后续行自动填充剩余余额（如第一行改为300元，第二行自动填充360元）
- **关联需求**: 增加实时"合计"金额显示
- **负责人**: 云霄 陈
- **状态**: ⏳ 待处理

### 3.3 控制申请/结算金额不超过原始金额
- **需求描述**: 后端校验申请/结算总额不超过费用金额
- **实现要点**: 
  - 结算单同一费用明细多次结算时控制金额
  - 多笔收款可以放预收
  - 后端限制不超过原始金额绝对值（负数同样适用，如-1000）
- **负责人**: ZC@WorkGroup
- **状态**: ⏳ 待处理

### 3.4 结算单核销金额合计
- **需求描述**: 结算单核销金额、核销金额本位币合计
- **负责人**: 待定
- **状态**: ⏳ 待处理

### 3.5 后端日常费用申请单数据获取问题
- **问题描述**: 获取数据不正确，查询不到明细
- **负责人**: ZC@WorkGroup
- **状态**: ⏳ 待处理

---

## 4. 🔻 低优先级任务

### 4.1 操作案例（BBS）前端开发
- **负责人**: 云霄 陈
- **状态**: ⏳ 待处理

---

## 5. ✅ 已完成任务

### 5.1 支出申请单出现发票申请界面
- **负责人**: 前端
- **状态**: ✅ 已完成

### 5.2 日常费用审批完没刷新导致数据残留
- **问题描述**: 审批完，新增申请时默认数据还是上一条内容
- **负责人**: 前端
- **状态**: ✅ 已完成

### 5.3 日常费用结算确认功能问题
- **问题描述**: 功能找不到，明细没有金额
- **负责人**: 前端
- **状态**: ✅ 已完成

### 5.4 GetAllCustomer 权限验证临时注销
- **问题描述**: 审批人无"查看客户资料"权限时无法审批
- **解决方案**: 已临时注释掉 GetAllCustomer 接口的权限验证（C.1.2）
- **技术债务**: 后续需精细化权限设计（按字段授权或独立查询接口）
- **负责人**: ZC@WorkGroup
- **状态**: ✅ 已完成
- **完成时间**: 2025-01-28
- **备注**: 这是临时方案，已记录为技术债务

---

## 6. 📝 测试流程清单

### 6.1 主营业务流程
建委托（工作号）→ 建费用（检查费用方案）→ 账单（检查合计金额）→ 申请单（检查合计金额、费用已申请金额、添加移除明细、余额）→ 审批流程 → 收入开发票 → 结算单（检查各合计金额、费用已结算金额）→ 结算单确认 → 工作号审核 → 关账（账期结转）→ 财务接口

### 6.2 日常费用流程
建申请 → 审批 → 拆分结算 → 结算确认 → 财务接口

---

## 7. ⚠️ 已知问题与待确认事项

### 7.1 主营业务收入审批无法选择下一审批人
- **原因**: 未配置流程
- **状态**: 待确认

---

**最后更新**: 2025-11-15
**优先级说明**: 🔥紧急 > ⚡高优先级 > 📌普通 > 🔻低优先级