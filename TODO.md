# PowerLms项目待办任务

## 🎯 **当前优先级任务**

### 🔄 **进行中任务**

#### 1. 通用字典导入导出功能完善 （架构已完成，剩余实现）

**已完成部分：**
- ✅ 需求澄清和架构设计
- ✅ 控制器API接口框架(`DataDicController.ImportExport.cs`)
- ✅ DTO定义(`DataDicController.Dto.cs`)
- ✅ 多租户安全控制逻辑
- ✅ 字典类型范围限制（9种字典，排除JobNumberRule、OtherNumberRule）
- ✅ Excel导出框架实现

**剩余核心工作：**

##### 1.1 权限验证逻辑实现 🔄 **优先级：高**
**当前状态：** 代码中有TODO注释，需要实现具体权限查找逻辑
```csharp
// 权限验证：搜索权限文件，如果有叶子权限符合要求就使用，如果没有就不进行权限验证
// TODO: 实现具体权限查找逻辑
```

**技术要求：**
- 搜索权限文件，找到叶子权限节点
- 如果有叶子权限符合要求就使用，如果没有就不进行权限验证
- 基础数据相关权限验证逻辑

**预估工期：** 0.5天

##### 1.2 Excel解析和导入逻辑实现 🔄 **优先级：高**
**当前状态：** `ImportDictionaryData<T>`方法只有框架，核心逻辑未实现
```csharp
private int ImportDictionaryData<T>(ISheet sheet, Guid? orgId, bool ignoreExisting) where T : class, new()
{
    // TODO: 实现具体的导入逻辑
    // 忽略Excel表中的OrgId数据，强制使用当前用户的OrgId
    _Logger.LogWarning("导入功能尚未完全实现：{EntityType}", typeof(T).Name);
    return 0;
}
```

**技术要求：**
- 基于NPOI解析Excel工作表数据
- 动态字段映射（Excel列头到实体属性）
- 数据类型转换和验证
- GUID自动生成
- 必填字段处理
- **强制OrgId设置**：完全忽略Excel中的OrgId值，使用当前用户OrgId
- 重复数据处理（基于ignoreExisting参数）
- 批量数据插入优化

**具体实现步骤：**
1. 解析Excel表头，建立字段映射关系
2. 逐行读取数据，进行类型转换
3. 创建实体对象，设置必要字段（Id、OrgId等）
4. 验证数据完整性
5. 批量保存到数据库

**预估工期：** 1天

##### 1.3 数据完整性和异常处理完善 🔄 **优先级：中**
**技术要求：**
- 完善异常处理机制
- 数据校验规则
- 事务一致性保证
- 详细的导入结果报告

**预估工期：** 0.5天

**总剩余工期：** 2天

---

## 📋 **计划中任务**

### 2. 主营业务结算单功能改造 （未开始）

#### 2.1 实体与数据库变更
**需求：** 根据Excel文档新增约13个字段到PlInvoices实体

**执行步骤：**
1. 分析现有PlInvoices实体结构
2. 对比Excel文档需求，确认新增字段列表  
3. 更新实体定义，添加新增字段属性
4. 配置数据注解和约束，更新字段注释
5. 数据库迁移（手动规划）

**字段设计要点：**
- 金额字段：decimal(18,2) - 两位小数
- 汇率字段：decimal(18,4) - 四位小数  
- 新增字段包括："收付单号"、"财务凭证号"、"是否导出到财务软件"等

**预估工期：** 1.5天

#### 2.2 通用实际收付记录表设计
**需求：** 处理一笔结算分多次收/付款场景

**执行步骤：**
1. 设计表结构ActualPaymentRecords
2. 创建对应实体类
3. 实现CRUD接口

**预估工期：** 1天

#### 2.3 计算工具接口开发
**需求：** 提供核销金额等复杂计算的统一接口

**技术要点：**
- 确保浮点数精度一致性
- 与金蝶导出算法保持一致
- 支持多币种计算

**预估工期：** 1天

### 3. 财务导出接口开发 （客户催促）

#### 3.1 财务单据导出接口
**需求：** 完成两个财务单据导出接口

**执行步骤：**
1. 分析现有导出代码
2. 设计导出接口（主营业务结算单导出、费用申请单导出）
3. 实现导出功能
4. 测试和优化

**技术要点：**
- 使用现有的任务调度机制
- 保持与发票导出一致的架构
- 支持条件筛选和权限过滤

**预估工期：** 2天

---

## 📊 **任务优先级排序**

| 任务 | 优先级 | 状态 | 预估工期 | 完成前置条件 |
|------|--------|------|----------|-------------|
| 字典导入导出功能完善 | 🔴 高 | 进行中 | 2天 | 权限逻辑 + Excel解析 |
| 财务导出接口开发 | 🔴 高 | 计划中 | 2天 | 客户催促，需尽快完成 |
| 实际收付记录表设计 | 🟡 中 | 计划中 | 1天 | 等字典功能完成 |
| 结算单实体改造 | 🟡 中 | 计划中 | 1.5天 | 需求最终确认 |
| 计算工具接口 | 🟡 中 | 计划中 | 1天 | 依赖实体改造完成 |

**总计剩余工期：** 7.5个工作日

---

## 🔧 **技术债务和注意事项**

### 权限验证待完善
- **位置**：`DataDicController.ImportExport.cs` 中的TODO注释
- **要求**：实现"搜索权限文件，如果有叶子权限符合要求就使用，如果没有就不进行权限验证"的逻辑
- **影响**：影响导入导出功能的安全性

### 导入逻辑待实现
- **位置**：`ImportDictionaryData<T>` 方法
- **状态**：目前只有架构框架，核心Excel解析和数据导入逻辑需要完善
- **风险**：功能无法正常使用

### 数据库变更风险
- **注意**：所有数据库变更必须手动规划，禁止使用EF自动迁移
- **要求**：制定详细的迁移脚本和回滚方案

---

## 💡 **开发提醒**

### 多租户数据隔离要求
**导出时：** 仅输出当前登录用户OrgId的数据，但**OrgId列不输出**  
**导入时：** **忽略Excel表中的OrgId数据，只用当前登录用户的OrgId**

### 字典类型范围限制
**包含：** PlCountry、PlPort、PlCargoRoute、PlCurrency、FeesType、PlCustomer、PlExchangeRate、UnitConversion、ShippingContainersKind  
**排除：** JobNumberRule、OtherNumberRule不导入/导出

### 代码质量要求
- 保持与现有代码风格一致
- 添加充分的注释和错误处理
- 重要功能需要编写单元测试
- 完成开发后更新相关技术文档