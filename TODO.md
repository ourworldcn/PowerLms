# 📋 PowerLms项目待办任务

<!-- 待办列表按照WBS编号法组织,使用emoji图标增强辨识度 -->

## 1. 🔴 紧急待完成任务(最高优先级)

### 1.1 申请单移除费用后已申请金额未正确恢复 ✅ **代码已修复 2025-02-19**

**当前状态:** 
- ✅ 代码修复完成并编译通过
- ⏳ 等待部署到测试环境
- ⏳ 等待业务方测试验证

**问题复现步骤:**
1. 新建一个费用，创建账单
2. 将费用添加到申请单
3. 从申请单中移除该费用
4. 再次尝试添加时，该费用在可选列表中消失

**根本原因:** 
触发器`FeeTotalTriggerHandler`在Saving阶段查询申请单明细时，结果包含了ChangeTracker中标记为Deleted的实体

**修复验证:** (已确认代码修复)
- ✅ `PowerLmsServer\Triggers\DocBill.Triggers.cs` 第161-168行
- ✅ 已添加两步过滤：先物化查询，再内存过滤Deleted实体
- ✅ 已添加调试日志输出

**后续操作:**
1. 部署到测试环境
2. 业务方验证测试（石永昌）
3. 可选：执行数据修复脚本修复历史数据（详见CHANGELOG.md）

### 1.2 通用进口新增工作号时接口报错409冲突 🔥

**问题:** 通用进口业务下新增工作号保存时返回409冲突错误，但刷新后数据实际已保存成功

**问题定位:** (已完成分析 2025-02-19)
- ✅ 409错误确实由`AddPlJob`方法中的工作号唯一性检查触发
- ✅ 但"数据已保存"说明是调用逻辑问题，非服务器端Bug
- ✅ 通用进口（OtId）没有对应的业务单据类型（无`PlOtDoc`实体）

**根本原因:**
1. `ProjectContent.OtId`（通用进口/贸易业务）在系统中缺少对应的业务单据实体
2. `AddPlJob`方法中没有对OtId的权限验证分支
3. 409冲突可能是前端重复调用或并发问题

**待办:** 
- 确认通用进口业务是否需要业务单据？还是只需PlJob主表？
- 如需创建，参考其他业务单据（PlEaDoc/PlIaDoc/PlEsDoc/PlIsDoc）的结构
- 检查前端是否存在重复提交或并发调用

**优先级:** 高（但需先明确业务需求）

### 1.3 业务结算单未按商户(OrgID)隔离 ✅ **代码已修复 2025-02-19**

**当前状态:**
- ✅ 代码修复完成并编译通过
- ⏳ 等待部署到测试环境
- ⏳ 等待业务方测试验证

**问题复现:** 
切换不同公司登录后，在业务结算单（DocBill）选择界面看到的数据完全一样，没有按公司隔离

**根本原因:** 
1. `DocBill`实体没有直接的`OrgId`字段
2. `GetAllDocBill`查询没有通过关联链条进行OrgId过滤
3. 其他增删改接口也缺少OrgId验证

**数据关联链条:**
```
DocBill (业务结算单)
  └─ DocFee (费用) [通过 BillId 关联] ✅ 必须存在
      └─ PlJob (工作号) [通过 JobId 关联]
          └─ OrgId (机构ID) ✅ PlJob.OrgId
```

**修复方案:** ✅ **通过LINQ关联查询实现OrgId间接隔离**

**修复内容:**
1. ✅ `GetAllDocBill` - 增加LINQ关联查询过滤（第21-38行）
   ```csharp
   var query = from bill in _DbContext.DocBills
               join fee in _DbContext.DocFees on bill.Id equals fee.BillId
               join job in _DbContext.PlJobs on fee.JobId equals job.Id
               where job.OrgId == context.User.OrgId
               select bill;
   var coll = query.Distinct().OrderBy(...).AsNoTracking();
   ```

2. ✅ `AddDocBill` - 增加OrgId一致性验证（第92-107行）
   - 验证所有费用关联的工作号属于当前用户的机构
   - 防止跨机构创建账单
   - 增加审计日志记录机构ID

3. ✅ `ModifyDocBill` - 增加OrgId权限验证（第178-195行）
   - 验证账单属于当前用户的机构
   - 验证新关联的费用属于当前用户的机构
   - 防止跨机构修改账单

4. ✅ `RemoveDocBill` - 增加OrgId权限验证（第296-308行）
   - 验证账单属于当前用户的机构
   - 防止删除其他机构的账单
   - 增加审计日志记录机构ID

5. ✅ `GetDocBillsByJobIds` - 增加OrgId过滤（第363-366行）
   - 验证所有工作号属于当前用户的机构
   - 查询时增加OrgId过滤条件

**技术要点:**
- ✅ 使用`Distinct()`去重（一个账单可能关联多个费用）
- ✅ 通过关联查询性能优化（有索引支持）
- ✅ 所有操作记录审计日志，包含机构ID
- ✅ 符合现有业务规则（账单必须关联费用）

**数据风险处理:**
- ⚠️ **孤立账单**：如果数据库中存在没有关联费用的历史账单，这些账单会被过滤掉
- **检测SQL**：`SELECT * FROM DocBills WHERE Id NOT IN (SELECT DISTINCT BillId FROM DocFees WHERE BillId IS NOT NULL)`
- **建议**：部署前运行检测SQL，确认是否存在孤立账单并进行数据清理

**后续操作:**
1. 部署到测试环境前运行孤立账单检测SQL
2. 如发现孤立账单，决策处理方式（删除/修复/保留）
3. 部署到测试环境
4. 业务方测试验证不同公司切换时的数据隔离效果

### 1.4 权限缓存加载异常 ⚠️

**问题:** 用户登录后放置一天，第二天早上访问时菜单和权限显示不正确，重启IIS后恢复

**分析:** 权限相关的缓存加载不正常，这是基础代码问题

**待办:** 排查权限缓存机制，修复隔夜异常问题

**优先级:** 高（但可能比较复杂，无法立即修复）

---

## 2. 📋 计划任务

### 2.1 增加查看所有申请单的权限支持

**需求:** 财务角色需要查看所有"主营业务申请单"和"日常费用申请单"，不受申请人或审批节点限制

**实现方案:** 当前端检测到用户拥有"查看所有申请单"权限时，审批列表接口返回所有申请单数据

**待办:** 
- 审批列表接口增加权限检测
- 根据权限返回全部数据或当前用户相关数据

**优先级:** 中

---

## 3. 🔄 暂缓任务

### 3.1 金蝶凭证分录逻辑重构 ⏸️

**需求背景:** 当前金蝶凭证生成逻辑过于简单，无法处理复杂业务场景（第三方付款、费用拆分等）

**核心变更:**
- 银行分录拆分：多笔收付款需生成独立分录，科目从银行账户动态获取
- 应收/应付分录拆分：根据结算单位国别和费用种类拆分成1-3条分录（国外客户/国内客户/关税）

**当前状态:** 等待业务方完成Excel规则文件编写

**下一步:** 待规则文件完成后召开专题会议评审，再进行开发

**优先级:** 高（但需等待前置条件）

---

## 4. ✅ 近期已解决问题

### 4.1 商户管理详情页白屏 ✅ **已解决 2025-02-19**

**问题:** 商户管理点击详情白屏，`getorg`接口返回不存在

**根因:** 后端改字段名引发的问题（字段名变更未完全同步）

**解决:** 前端已修复并部署测试环境（前端任务，非服务器端问题）

**解决人:** 陈云霄(前端)

---

## 📝 备注

- **状态说明:**
  - ✅ **已完成**: 代码修复完成且编译通过
  - ✅ **已解决**: 问题已完全解决并验证
  - ⏳ **待测试**: 等待测试验证
  - 🔥 **高优先级**: 需要尽快处理
  - ⚠️ **需关注**: 问题复杂，需要持续关注
  - ⏸️ **等待中**: 等待外部条件满足

- **任务范围:** 仅记录服务器端任务，前端任务不在此列表中
- **详细信息:** 技术方案和修复记录详见 CHANGELOG.md
- **代码验证:** 
  - 1.1任务代码已在 `PowerLmsServer\Triggers\DocBill.Triggers.cs` 第161-168行确认完成
  - 1.3任务代码已在 `PowerLmsWebApi\Controllers\Business\Common\PlJobController.DocBill.cs` 修复完成
    - GetAllDocBill: 第21-38行（LINQ关联查询过滤）
    - AddDocBill: 第92-107行（OrgId一致性验证）
    - ModifyDocBill: 第178-195行（OrgId权限验证）
    - RemoveDocBill: 第296-308行（OrgId权限验证）
    - GetDocBillsByJobIds: 第363-366行（OrgId过滤）