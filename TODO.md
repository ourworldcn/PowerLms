# 📋 待办任务列表

**基于会议时间**：2026-02-08
**负责人**：ZC@WorkGroup（后端）

---

## 🚨 紧急任务

暂无

---

## 📅 计划任务

### 2.1 进口仓单功能开发（新功能）

**优先级**：高
**计划完成时间**：2月11日或12日
**状态**：进行中

#### 2.1.1 业务背景
- **定义**：进口仓单用于海关报关，由出口方的主分单信息中提取关键数据生成
- **监管单位**：
  - 主分单：航空公司（货代与航司的合同）
  - 仓单：海关的仓单科
- **业务流程**：
  1. 货物从国外起飞后，出口方代理将仓单数据传给国内（进口方）
  2. 进口方货代系统接收/录入仓单数据，用于后续向海关申报
  3. 货物到港后，进行理货、入库等操作，并将状态回传给海关仓单科
  4. 海关核对航空公司舱单与货代报关单，一致后放行
- **本期目标**：实现仓单数据的CRUD（增删改查）和手动录入功能
- **未来规划**：与海关仓单科系统进行API对接，实现数据自动下载和状态回传

---

#### 2.1.2 数据模型设计（✅ 已完成）

**实体文件位置**：
- 文件：`PowerLmsData/主营业务/空运进口/IaManifest.cs`
- 主表：`IaManifest`（空运进口舱单主表，Ia=Import Air，Manifest为国际货代行业标准术语）
- 子表：`IaManifestDetail`（空运进口舱单明细）
- .NET命名规范：缩写`Ia`遵循.NET规范，只首字母大写，避免三个连续大写字母

**已完成工作**：
- ✅ 创建实体类（主表和子表在同一文件中）
- ✅ 添加所有必需字段和注释
- ✅ 设置主外键关系和导航属性
- ✅ 添加索引（OrgId + MawbNo, ParentId, MawbNo + HBLNO）
- ✅ DbContext注册（PowerLmsUserDbContext.cs）
- ✅ 代码编译验证通过
- ✅ 重命名为国际标准术语，遵循.NET命名规范

**技术细节**：
- 时间字段精度：`[Precision(3)]`（精确到毫秒）
- Decimal字段精度：`[Precision(18,3)]`（3位小数）
- 主单号格式：11位纯数字，原样存储
- 主子表关联：通过ParentId外键和导航属性

---

#### 2.1.3 创建仓单CRUD接口（✅ 已完成）

**已完成工作**：
- ✅ 创建控制器：`IaManifestController.cs`（与主表实体`IaManifest`对应）
  - 位置：`PowerLmsWebApi/Controllers/Business/AirFreight/IaManifestController.cs`
  - 路由：`/api/IaManifest/*`
  - 业务归属：空运进口业务模块
  - 命名规范：采用国际货代行业标准术语`Manifest`（舱单），前缀`Ia`（Import Air）
  - .NET命名规范：缩写`Ia`只首字母大写，遵循.NET规范
- ✅ 创建DTO文件：`IaManifestController.Dto.cs`
- ✅ 实现主表接口（IaManifest）：
  - `GetAllManifest` - 查询空运进口舱单列表（支持分页和条件过滤）
  - `GetManifest` - 查询单个空运进口舱单详情（含子表）
  - `AddManifest` - 创建空运进口舱单（主表+子表）
  - `ModifyManifest` - 更新空运进口舱单（主表）
  - `RemoveManifest` - 删除空运进口舱单
- ✅ 实现子表接口（IaManifestDetail）：
  - `GetAllManifestDetail` - 查询空运进口舱单明细列表
  - `AddManifestDetail` - 创建空运进口舱单明细
  - `ModifyManifestDetail` - 更新空运进口舱单明细
  - `RemoveManifestDetail` - 删除空运进口舱单明细
- ✅ **智能关联功能（分单优先策略）**（2026-02-08完成）：
- 子表新增`MawbId`字段（Guid?），采用**分单优先策略**
- **核心逻辑**：
  - 有分单号（HBLNO不为空）→ `MawbId`直接指向**分单ID**（EaHawb.Id）
  - 无分单号（HBLNO为空）→ `MawbId`直接指向**主单ID**（EaMawb.Id）
- **设计优势**（为什么这样记录）：
  1. **避免重复查询**：通过分单可直接访问主单信息（EaHawb.MawbNo），无需重新标准化分单号再查找
  2. **提高查询效率**：需要分单信息时直接通过MawbId查询，减少50%查询次数
  3. **数据关联清晰**：通过HBLNO是否为空即可判断MawbId指向的实体类型
  4. **扩展性好**：分单包含主单号，可以追溯到主单，支持复杂业务场景
- **验证机制**（确保数据一致性）：
  - ❌ 找不到对应主单/分单时，**必须返回BadRequest拒绝保存**
  - ✅ 只有已在系统中存在的主单/分单才能被舱单引用
  - 🔍 详细错误消息提示用户检查单号或先创建主单/分单
- **技术实现**：
  - 保存时自动标准化主单号/分单号（去空格，主单号保留横杠为999-12345678格式）
  - 主单号/分单号原样保存（海关11位纯数字格式），内部通过GUID关联业务数据
  - 不建立物理外键，保持灵活性
  - 详细注释已写在`IaManifestController.FindRelatedMawb`方法中

**技术实现**：
- 遵循架构分层：API→Server(Manager)→Data
- 控制器只做校验和异常处理
- 控制器命名与实体对应：`IaManifestController` ↔ `IaManifest`
- 实体命名采用国际标准：`IaManifest`（主表）、`IaManifestDetail`（子表）
- 注释明确标注：空运进口业务模块
- 支持按ParentId或MawbNo查询明细
- 删除主表前检查是否存在明细
- 完整的异常处理和日志记录
- .NET命名规范：缩写`Ia`遵循.NET规范，避免三个连续大写字母
- **主单号/分单号标准化**：
  - 去除空格、横杠等分隔符
  - 兼容多种前端输入格式（如"999-12345678"、"999-1234 5678"、"99912345678"）
  - 通过标准化后的号码查找EaMawb/EaHawb
  - 建立GUID外键关联（MawbId/HawbId）

---

#### 2.1.4 仓单数据校验逻辑

**任务详情**：
- **主分单识别**：
  - 通过"分单号"字段是否为空来区分主单行和分单行
  - "分单号"为空 → 主单信息
  - "分单号"不为空 → 分单信息
- **数据一致性校验（手动录入时）**：
  - 一个主单号下的所有分单行的"件数"、"重量"等数据之和，应等于主单行的对应数据
  - 所有行（无论主单还是分单）都必须有主单号
- **后端校验**：
  - 保存时，将仓单科传入的原始主单号作为显示字段
  - 内部通过标准化转换，校验主单是否存在
  - 用GUID建立后台关联
- **直单 (Direct Bill) 处理**：
  - 指没有分单，只有主单的情况
  - 在子表中表现为只有一行数据，且该行的"分单号"为空

**技术要点**：
- 保存前数据验证
- 主分单关联校验
- 数据汇总一致性检查

---

#### 2.1.5 工作号生成功能

**任务详情**：
- 提供"生成工作号"功能
- 利用仓单信息（主单号、收发货人等）预填内部工作号的字段
- 减少重复录入

**技术要点**：
- 工作号生成规则
- 仓单数据到工作号的字段映射

---

## ⏸️ 暂缓任务

暂无

---

## 📝 备注

### 时间安排
- **接口开发**：后端（ZC@WorkGroup）将在**11号或12号前**完成仓单功能的API开发
- **后续会议**：因临近春节假期，下次会议安排在**年后（暂定21号，破五之后）**再碰头讨论海运及更复杂的报关单模块

### 技术约束
- 数据库迁移由开发人员手工执行，不生成迁移文件
- 遵循架构分层：API→Server(Manager)→Data→基础设施
- 业务逻辑归Manager类，控制器只做校验和异常处理
- 不使用异步模式

### 前后端协作
- 前端（陈云霄）继续完成主分单制作，然后搭建仓单的CRUD界面
- 后端需在约定时间前完成API开发，确保前端能够按时对接
