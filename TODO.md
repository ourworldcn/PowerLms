# PowerLms项目待办任务

## 🎯 **当前优先级任务 (目标：9月2日前完成)**

### 🔄 **进行中任务**

#### 1. 通用字典导入导出功能完善 （架构已完成，按类型分别导出）

**会议决议变更：**
- ✅ 导出方式：改为按字典类型分别导出（非一次性导出所有）
- ✅ 简单字典：按分类导入导出，仅处理字典项不含分类本身
- ✅ 重复数据策略：采用覆盖（Update）模式，确保数据与导入文件一致

**已完成部分：**
- ✅ 需求澄清和架构设计
- ✅ 控制器API接口框架(`DataDicController.ImportExport.cs`)
- ✅ DTO定义(`DataDicController.Dto.cs`)
- ✅ 多租户安全控制逻辑
- ✅ 字典类型范围限制（9种字典，排除JobNumberRule、OtherNumberRule）
- ✅ Excel导出框架实现

**剩余核心工作：**

##### 1.1 权限验证逻辑实现 🔄 **优先级：高**
**当前状态：** 代码中有TODO注释，需要实现具体权限查找逻辑
```csharp
// 权限验证：搜索权限文件，如果有叶子权限符合要求就使用，如果没有就不进行权限验证
// TODO: 实现具体权限查找逻辑
```

**预估工期：** 0.5天

##### 1.2 按类型导出功能调整 🔄 **优先级：高**
**技术要求：**
- 调整导出接口，支持按传入的类型标识导出对应数据
- 简单字典按分类code进行导入导出
- 客户资料暂时仅处理主表

**预估工期：** 0.5天

##### 1.3 Excel解析和导入逻辑实现 🔄 **优先级：高**
**技术要求：**
- 重复数据采用覆盖（Update）策略
- 验证字典间依赖关系，依赖不存在时阻止导入
- 强制OrgId设置：完全忽略Excel中的OrgId值，使用当前用户OrgId

**预估工期：** 1天

**总剩余工期：** 2天

---

## 🔴 **紧急新增任务（会议决议）**

### 2. 申请单审批流程回退功能 🆕 **优先级：最高**

#### 2.1 一键回退功能开发
**业务需求：** 已审批完成的申请单发现错误时，需要撤销到初始状态以便修改

**核心逻辑：**
1. **权限控制** - 专门权限，非人人可用
2. **日志记录** - 生成当前状态快照存入系统日志
3. **清空审批流** - 删除所有已生成的审批节点
4. **状态回退** - 将主表状态改回"初始状态/未提交"
5. **保留明细** - 表头和明细数据保留，触发trigger释放关联费用
6. **消息通知** - 向审批流相关人员发送撤销通知

**适用范围：** 主营业务申请单 + OA费用申请单

**预估工期：** 2天

#### 2.2 拒绝操作逻辑优化
**技术要求：** 修改现有拒绝操作，使其同样能将单据状态回退至初始状态

**预估工期：** 0.5天

### 3. 账期管理与工作号关闭机制 🆕 **优先级：最高**

#### 3.1 机构参数表设计
**新增表结构：** 与机构一对一关联的参数表

**核心字段：**
- `current_accounting_period` - 当前账期（YYYYMM格式，只读）
- `账单抬头1`、`账单抬头2`、`账单落款` - 报表打印用

**预估工期：** 1天

#### 3.2 关闭账期功能开发
**核心逻辑：**
1. 有权限的财务操作
2. 批量关闭财务日期在当前账期内的所有工作号
3. 自动递增账期至下一月
4. 废除原有的单票/批量关闭工作号功能

**预估工期：** 1.5天

### 4. 财务日期逻辑重构 🆕 **优先级：高**

#### 4.1 财务日期联动逻辑
**新逻辑：**
- 财务日期改为只读字段
- **进口业务**：财务日期 = 到港日期
- **出口业务**：财务日期 = 开航日期
- **约束**：到港/开航日期不能选择当前月份之前的日期

**预估工期：** 1天

---

## 📋 **其他功能优化任务**

### 5. 费用列表申请单详情展示 🆕

**需求：** 点击费用列表的"已申请金额"显示相关申请单信息
**技术方案：** 弹窗列表展示申请单号、金额、申请人、时间

**预估工期：** 1天

### 6. OA费用申请单增加公司字段 🆕

**需求：** 主表增加"公司"字段关联客户资料表
**用途：** 支持个人费用场景下的公司选择

**预估工期：** 0.5天

### 7. 客户资料有效性管理 🆕

**需求：** 增加有效/无效状态（软删除）
**功能：** 带权限的状态切换，选择器默认只显示有效客户

**预估工期：** 1天

### 8. 客户选择器优化 🆕

**需求：** 改为弹出式窗口，显示更多字段，支持多维度搜索
**字段：** 名称、简称、财务编码、是否超期、是否超额
**搜索：** 按名称、简称、财务编码模糊搜索

**预估工期：** 2天

---

## 📊 **任务优先级排序（更新后）**

| 任务 | 优先级 | 状态 | 预估工期 | 目标完成时间 |
|------|--------|------|----------|-------------|
| 申请单一键回退功能 | 🔴 最高 | 新增 | 2.5天 | 8月21日 |
| 账期管理机制 | 🔴 最高 | 新增 | 2.5天 | 8月23日 |
| 财务日期逻辑重构 | 🔴 高 | 新增 | 1天 | 8月24日 |
| 字典导入导出功能完善 | 🔴 高 | 进行中 | 2天 | 8月26日 |
| 费用列表申请单详情 | 🟡 中 | 新增 | 1天 | 8月27日 |
| OA申请单公司字段 | 🟡 中 | 新增 | 0.5天 | 8月27日 |
| 客户资料有效性管理 | 🟡 中 | 新增 | 1天 | 8月28日 |
| 客户选择器优化 | 🟡 中 | 新增 | 2天 | 8月30日 |

**总计剩余工期：** 12.5个工作日  
**目标完成时间：** 2025年9月2日  
**风险评估：** 中等 - 核心流程变更较多，需紧密配合

---

## 🔧 **技术债务和注意事项**

### 权限验证待完善
- **位置**：`DataDicController.ImportExport.cs` 中的TODO注释
- **要求**：实现"搜索权限文件，如果有叶子权限符合要求就使用，如果没有就不进行权限验证"的逻辑
- **影响**：影响导入导出功能的安全性

### 核心流程变更风险
- **申请单回退功能**：涉及审批流核心逻辑，需仔细测试
- **账期管理**：改变工作号关闭机制，需确保向后兼容
- **财务日期联动**：影响业务流程，需要充分验证

### 数据库变更风险
- **注意**：所有数据库变更必须手动规划，禁止使用EF自动迁移
- **要求**：制定详细的迁移脚本和回滚方案
- **新增表**：机构参数表需要完整的CRUD接口和权限控制

---

## 💡 **开发提醒**

### 多租户数据隔离要求
**导出时：** 仅输出当前登录用户OrgId的数据，但**OrgId列不输出**  
**导入时：** **忽略Excel表中的OrgId数据，只用当前登录用户的OrgId**

### 字典类型范围限制
**包含：** PlCountry、PlPort、PlCargoRoute、PlCurrency、FeesType、PlCustomer、PlExchangeRate、UnitConversion、ShippingContainersKind  
**排除：** JobNumberRule、OtherNumberRule不导入/导出

### 权限控制要求
- **一键回退功能**：需要专门权限，并非人人可用
- **关闭账期功能**：财务人员专用权限
- **机构参数编辑**：需要单独权限
- **客户状态切换**：需要权限控制

### 代码质量要求
- 保持与现有代码风格一致
- 添加充分的注释和错误处理
- 重要功能需要编写单元测试
- 完成开发后更新相关技术文档

### 会议关键决议执行
1. **导入逻辑**：重复数据采用覆盖（Update）策略
2. **废弃功能**：原有单票/批量关闭工作号功能将被废除
3. **客户选择**：默认只显示"有效"客户
4. **申请单回退**：适用于主营业务申请单和OA费用申请单
5. **财务日期**：改为只读字段，由其他日期联动决定