# 主营业务付款结算单导出金蝶功能设计

## 1. 📋 功能概述

### 1.1 业务目标
实现付款结算单的财务导出功能，将PowerLms中的付款结算单转换为符合金蝶财务软件要求的会计凭证分录，支持DBF格式导出。

### 1.2 技术架构
- 基于现有收款结算单导出功能进行设计
- 采用相同的异步任务处理机制
- 复用DotNetDBF库进行文件生成
- 权限控制和数据隔离机制一致

## 2. 🔄 业务规则设计

### 2.1 核心业务逻辑
付款凭证的生成逻辑与收款凭证大体相同，主要区别：
1. **借贷方向相反**：收款时借方变为付款时的贷方
2. **科目对应关系**："应收账款"变为"应付账款"
3. **手续费处理逻辑完全不同**：付款手续费需要生成两条分录自行轧平

### 2.2 基础规则
1. **贷方金额计算**：
   - 多笔付款：贷方金额 = 付款金额 × 结算单汇率
   - 单笔付款：本位币金额由前端计算提供

2. **应付本位币处理**：
   - 应付合计的本位币金额处理方式与应收逻辑一致
   - 支持多币种和汇率转换

3. **汇兑损益**：
   - 规则与收款一致，但借贷方向相反
   - 汇兑收益记贷方，汇兑损失记借方

### 2.3 多笔付款处理逻辑
**核心原则**：优先使用多笔付款记录，其次使用结算单付款金额
1. **多笔付款场景**：
   - 如果付款结算单拆分成了多笔付款记录
   - 以多笔付款记录的金额生成银行付款分录
   - 结算单的付款金额不参与分录生成

2. **单笔付款场景**：
   - 没有多笔付款记录的情况
   - 以结算单的付款金额生成银行付款分录

3. **技术实现**：
   - 检查是否存在多笔付款明细
   - 根据付款明细数量选择不同的金额来源
   - 确保分录金额的准确性和一致性

### 2.4 关键差异：手续费处理

#### 2.4.1 付款手续费（新增逻辑）
**业务场景**：付款时银行额外收取的费用
- 示例：公司付款10000元给供应商，银行收取5元手续费，实际从公司账户扣除10005元
- **凭证生成**：两条分录自行轧平
  1. 借方：手续费科目（财务费用）- 5元
  2. 贷方：付款银行科目 - 5元

#### 2.4.2 收款手续费（对比参考）
**业务场景**：收款时银行从收到的钱中扣除的费用
- 示例：客户汇10000美金，银行扣手续费后实际入账人民币减少
- **凭证生成**：仅一条借方分录，无对应贷方

## 3. 📊 凭证分录规则设计

基于详细设计规则，明确六种付款结算单分录规则：

### 3.1 规则1：银行付款（贷方）- 必须生成
- **业务含义**：记录银行账户资金减少
- **科目来源**：用户在界面选择的付款银行账户科目代码（BankInfo.AAccountSubjectCode）
- **借贷方向**：贷方（资产减少）
- **金额处理**：
  - **多笔付款**：按每笔付款明细生成独立分录，使用明细的付款金额
  - **单笔付款**：使用结算单的总付款金额生成一条分录
- **适用场景**：所有付款都会产生此分录

### 3.2 规则2：应付账款冲销（借方）- 必须生成
- **业务含义**：减少对供应商的欠款
- **科目来源**：系统配置的应付账款科目
- **借贷方向**：借方（负债减少）
- **金额**：所有支出明细的本位币金额合计
- **往来信息**：记录供应商的财务编码和名称

### 3.3 规则3：应收账款增加（贷方）- 混合业务时生成
- **业务含义**：在付款单中如果有收入项目，增加对客户的应收款
- **触发条件**：付款单中既有支出又有收入项目
- **科目来源**：系统配置的应收账款科目
- **借贷方向**：贷方（资产增加）
- **金额**：所有收入明细的本位币金额合计

### 3.4 规则4：汇兑损益处理 - 有汇率差异时生成
- **业务含义**：记录因汇率变动产生的损益
- **触发条件**：结算汇率与原始汇率不同时产生汇兑差异
- **科目来源**：系统配置的汇兑损益科目
- **借贷方向**：借方（与收款相反）
- **金额**：汇兑损益的绝对值

### 3.5 规则5：手续费支出（借方）- 有手续费时生成
- **业务含义**：记录付款时产生的银行手续费
- **触发条件**：付款时银行收取手续费
- **科目来源**：系统配置的财务费用科目
- **借贷方向**：借方（费用增加）
- **金额**：手续费的金额

### 3.6 规则6：手续费银行扣款（贷方）- 有手续费时生成
- **业务含义**：记录银行因手续费扣减的资金
- **触发条件**：与规则5配对出现
- **科目来源**：付款银行账户科目代码（同规则1）
- **借贷方向**：贷方（资产减少）
- **金额**：与规则5相同的手续费金额
- **平衡关系**：与规则5形成完整的手续费处理

## 4. 🔧 科目配置管理

### 4.1 必需科目配置列表
系统需要预先配置以下科目代码：

| 配置名称 | 业务用途 | 会计性质 |
|---------|---------|----------|
| SP_PAYABLE_DEBIT | 应付账款科目（用于冲销供应商欠款） | 借方 |
| SP_RECEIVABLE_CREDIT | 应收账款科目（混合业务中的收入部分） | 贷方 |
| SP_EXCHANGE_LOSS | 汇兑损益科目（汇率差异处理） | 借方 |
| SP_SERVICE_FEE_DEBIT | 财务费用科目（银行手续费） | 借方 |
| SP_PREPARER | 制单人姓名 | - |
| SP_VOUCHER_GROUP | 凭证字（如"银"、"现"等） | - |

### 4.2 科目配置存储和管理
- **存储位置**：所有科目配置存储在SubjectConfigurations表中
- **配置前缀**：SP_开头的付款配置与SR_开头的收款配置在同一张表中
- **组织隔离**：配置按OrgId进行组织隔离
- **缺失处理**：当科目配置缺失时，提供默认科目代码作为备选

### 4.3 特殊科目处理
**银行科目**：收、付款时从同一银行账户转账，科目代码相同，仅借贷方向不同
- 收款：银行科目为借方（资产增加）
- 付款：银行科目为贷方（资产减少）

## 5. 🗄️ 数据结构设计

### 5.1 已确认数据库信息
- **付款结算单标识**：PlInvoices表中IO=false表示付款，IO=true表示收款
- **导出状态**：ConfirmDateTime为null表示未导出，有值表示已导出
- **明细关联**：PlInvoicesItems → DocFeeRequisitionItems → DocFees
- **供应商信息**：JiesuanDanweiId字段关联到PlCustomers表（供应商也存储在此表中）
- **银行账户信息**：机构的开户行信息，包含银行账户的A账科目代码（AAccountSubjectCode）
- **权限控制**：基于用户的组织权限进行数据过滤

### 5.2 供应商和银行信息获取
- **供应商来源**：所有供应商都存储在PlCustomers表中，通过JiesuanDanweiId关联
- **供应商财务编码**：使用PlCustomers表中的FinanceCodeAP字段（应付账款财务编码）
- **银行账户**：从机构的开户行信息中获取，包含A账科目代码用于凭证生成

### 5.3 多笔付款数据处理
- **多笔付款检测**：检查付款结算单是否存在多笔付款明细记录
- **金额来源选择**：
  - 有多笔付款：使用每笔付款明细的金额和汇率
  - 无多笔付款：使用结算单的总付款金额和汇率
- **分录生成策略**：
  - 多笔付款：为每笔付款生成独立的银行分录
  - 单笔付款：生成一条银行分录

### 5.4 手续费字段信息
- **手续费原币金额**：ServiceFeeAmount字段，同时适用于收款和付款
- **手续费本位币金额**：ServiceFeeBaseCurrency字段，同时适用于收款和付款
- **手续费币种处理**：
  - 仅本位币手续费：币种=本位币，汇率=1，外币金额=本位币金额
  - 原币+本位币手续费：币种=结算币种，汇率=结算汇率，外币金额=原币金额

### 5.5 混合业务逻辑
- **混合业务识别**：通过DocFees.IO字段统计收入（IO=true）和支出（IO=false）项目数量
- **触发条件**：当付款单中既有收入项目又有支出项目时，为混合业务
- **业务场景**：实际业务中存在但不常见，主要用于复杂的结算情况

### 5.6 金额计算逻辑
- **应付合计计算**：sum(支出明细本次结算金额 × 明细原费用汇率)
- **应收合计计算**：sum(收入明细本次结算金额 × 明细原费用汇率)
- **明细原费用汇率**：从DocFees.ExchangeRate字段获取
- **汇兑损益计算**：使用与收款相同的公式，但借贷方向相反

### 5.7 摘要和命名规范
- **摘要格式**：往来单位名+【支出】+付款单号
- **往来单位名**：从PlCustomers.Name字段获取（收款用Name_Name字段）
- **文件命名**：SettlementPayment_Export_yyyyMMdd_HHmmss.dbf
- **权限代码**：复用收款的"F.6"权限进行付款功能的权限控制

### 5.8 凭证字段映射
复用收款结算单的21个金蝶字段：
- 日期字段：FDATE（制单日期）、FTRANSDATE（凭证日期）、FPERIOD（期间）
- 编号字段：FNUM（凭证号）、FENTRYID（分录号）、FGROUP（凭证字）
- 科目字段：FACCTID（科目代码）、FEXP（摘要）
- 往来字段：FCLSNAME1（核销类别）、FOBJID1（客户财务编码）、FOBJNAME1（客户名称）、FTRANSID（客户财务编码）
- 金额字段：FCYID（币种）、FEXCHRATE（汇率）、FDC（借贷方向）、FFCYAMT（外币金额）、FDEBIT（金额借方）、FCREDIT（金额贷方）
- 其他字段：FPREPARE（制单人）、FMODULE（模块）、FDELETED（删除标记）

## 6. 🎯 完整设计确认要点

### 6.1 已确认的设计要素
1. **六种分录规则**完整覆盖付款业务场景
2. **手续费双分录**确保借贷平衡
3. **混合业务**支持一单既有收入又有支出
4. **汇兑损益**处理多币种业务
5. **权限控制**保证数据安全，复用"F.6"权限
6. **异步处理**提高用户体验
7. **供应商管理**：所有供应商存储在PlCustomers表，使用FinanceCodeAP作为财务编码
8. **银行账户**：从机构开户行信息获取科目代码，收付款使用相同科目但借贷方向相反
9. **科目配置**：SP_和SR_配置存储在同一SubjectConfigurations表中
10. **手续费字段**：ServiceFeeAmount和ServiceFeeBaseCurrency同时适用于收款和付款
11. **混合业务识别**：通过DocFees.IO统计收入支出项目数量
12. **金额计算**：使用DocFees.ExchangeRate作为明细原费用汇率
13. **摘要格式**：使用"【支出】"标识付款业务，往来单位名从PlCustomers.Name获取
14. **多笔付款处理**：优先使用多笔付款记录生成分录，无多笔付款时使用结算单金额

### 6.2 技术实现策略
1. **复用架构**：基于收款结算单的成功经验
2. **数据隔离**：按用户组织权限过滤数据
3. **错误处理**：完善的异常处理和日志记录
4. **性能优化**：大数据量的分批处理机制
5. **借贷平衡**：每个凭证的借方总额必须等于贷方总额
6. **字段验证**：确保科目代码和摘要等必需字段的完整性
7. **多笔付款优先**：检测多笔付款存在性，选择正确的金额来源

### 6.3 核心业务逻辑要点
1. **付款金额选择**：
   - 存在多笔付款：使用各笔付款明细金额，为每笔生成银行分录
   - 不存在多笔付款：使用结算单总付款金额，生成一条银行分录
2. **科目代码一致性**：收付款使用相同银行科目，仅借贷方向不同
3. **手续费平衡处理**：付款手续费生成借贷配对分录，确保自平衡
4. **混合业务支持**：同时处理付款单中的收入和支出项目
5. **汇率处理**：支持多币种结算和汇兑损益计算

---

**设计原则**：本设计文档为完整的实施依据，涵盖了付款结算单导出的所有业务规则、技术要点和实现细节。基于收款结算单的成功架构，通过借贷方向调整、多笔付款优先处理和手续费双分录机制，确保付款凭证的准确性和会计平衡。所有疑问已解决并融入设计，可直接用于技术实现。