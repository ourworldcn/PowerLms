# 账期反关闭(Re-open Period)功能开发计划

## 1. 需求分析

### 1.1 业务背景
配合财务操作习惯(类似金蝶),允许"反结账/反关闭",将当前账期倒退一个月(如从8月退回7月)

### 1.2 关键逻辑限制
- 逐月倒退: 只能8月到7月到6月,不可跳跃
- 可选解关: 通过isUncloseJobs参数控制是否同时解关该账期下的所有工作号
  - 勾选: 工作号恢复为可编辑状态
  - 不勾选: 仅账期回退,工作号仍保持关闭状态

### 1.3 业务价值
- 场景A(仅调账期): 财务发现账期设置错误,需要倒退但不影响业务数据
- 场景B(调业务): 需要修改已关闭工作号的业务数据,必须解关工作号

---

## 2. 技术方案设计

### 2.1 数据模型分析
已有字段(基于PowerLmsData索引):
- PlOrganizationParameter.CurrentAccountingPeriod: 当前账期(YYYYMM格式)
- PlJob.JobState: 工作号状态(16=已关闭)
- PlJob.CloseDate: 关闭时间
- PlJob.ClosedBy: 关闭人
- PlJob.AccountDate: 财务日期(用于判断归属账期)

无需新增字段: 现有字段足够支持反关闭逻辑

### 2.2 核心逻辑设计(已确认)
账期回退逻辑: 当前账期202508 到 目标账期202507

工作号解关逻辑:
  IF isUncloseJobs = true:
    1. 计算目标账期的日期范围(202507 = 2025-07-01 到 2025-08-01)
    2. 查找所有满足条件的工作号:
       - OrgId = 当前机构
       - JobState = 16 (已关闭)
       - AccountDate >= 2025-07-01 AND AccountDate < 2025-08-01
    3. 批量更新:
       - JobState = 8 (已审核,可编辑)
       - CloseDate = null
       - ClosedBy = null
  ELSE:
    仅更新机构参数表的账期,不触碰工作号

注意: 按财务日期(AccountDate)判断,不是按创建日期

### 2.3 安全校验设计(已确认)
1. 权限验证: 复用F.2.9权限(关闭账期权限)
2. 账期连续性: 不允许跳跃,只能逐月倒退(从逻辑上保证)
3. 最小账期: 不限制,理论上可以一直倒退
4. 混合状态: 允许倒退后的账期同时存在已关闭和未关闭的工作号

---

## 3. 实施计划

### 3.1 Manager层业务逻辑
位置: PowerLmsServer/Managers/Business/JobManager.cs

新增方法: ReopenAccountingPeriod
参数: orgId, isUncloseJobs, operatorId, dbContext
返回: ReopenAccountingPeriodResult

实现步骤:
1. 获取当前账期
2. 计算目标账期(当前账期-1个月)
3. 验证账期有效性
4. 更新机构参数表
5. 如果isUncloseJobs=true,批量解关工作号
6. 记录操作日志

### 3.2 Controller层API接口
位置: PowerLmsWebApi/Controllers/Business/Common/PlJobController.cs

新增方法: ReopenAccountingPeriod(HttpPost)

实现步骤:
1. Token验证
2. 权限验证(F.2.9)
3. 调用JobManager.ReopenAccountingPeriod
4. 返回结果(旧账期/新账期/影响的工作号数量)

### 3.3 DTO定义
位置: PowerLmsWebApi/Controllers/Business/Common/PlJobController.Dto.cs

新增类:
- ReopenAccountingPeriodParamsDto: 参数类(Token, IsUncloseJobs)
- ReopenAccountingPeriodReturnDto: 返回类(OldAccountingPeriod, NewAccountingPeriod, UnclosedJobCount, Message)

### 3.4 Manager层结果模型
位置: PowerLmsServer/Managers/Business/JobManager.cs

新增类: ReopenAccountingPeriodResult
包含: Success, OldPeriod, NewPeriod, UnclosedJobCount, ErrorMessage

---

## 4. 已确认的业务规则

### 4.1 核心规则:反关闭后解关哪些工作号
**确认结果**: 解关倒退后账期的工作号
- 当前账期8月(202508),反关闭到7月(202507)
- 如果勾选"同时解关工作号",解关财务日期在7月(202507)的已关闭工作号
- 按财务日期(AccountDate)计算

### 4.2 账期倒退限制
**确认结果**: 不限制
- 理论上可以一直倒退,只要操作人需要
- 通过权限控制(F.2.9)即可

### 4.3 账期可以混合状态
**确认结果**: 允许
- 反关闭后,倒退账期可能同时存在:
  - 之前遗漏未关闭的工作号
  - 本次反关闭解关的工作号
- 由财务人员自己判断和处理

### 4.4 费用状态不变
**确认结果**: 费用状态保持不变
- 解关工作号后,已结算的费用仍然是"已结算"状态
- 如需修改费用,财务需要先:删除结算单→删除申请单→删除账单→修改费用

---

## 5. 业务控制体系说明(已确认)

### 5.1 双线控制模式
货代行业的业务控制采用**业务主管**和**财务主管**互相制约的模式:
- **业务线**: 工作号的关闭、审核(控制业务信息数据)
- **财务线**: 申请单、结算单(控制费用)

### 5.2 财务月=账期
- **财务月就是账期**: PlOrganizationParameter.CurrentAccountingPeriod
- 与金蝶等财务软件的概念相呼应
- **财务日期**: PlJob.AccountDate字段

### 5.3 本次实施范围
**明确范围**: 本次只实现工作号的反关闭功能
- 实现: 账期倒退 + 工作号解关
- 不涉及: 申请单、结算单的财务月校验
- 不涉及: 新建工作号的财务日期校验(这些是现有功能或未来功能)

---

## 6. 后端实施顺序

第一步: Manager层实现
- [ ] 在JobManager.cs中添加ReopenAccountingPeriodResult类
- [ ] 在JobManager.cs中实现ReopenAccountingPeriod方法
- [ ] 实现账期计算逻辑(YYYYMM-1个月)
- [ ] 实现工作号批量解关逻辑

第三步: DTO定义
- [ ] 在PlJobController.Dto.cs中添加请求DTO
- [ ] 在PlJobController.Dto.cs中添加返回DTO

第四步: Controller层实现
- [ ] 在PlJobController.cs中实现ReopenAccountingPeriod接口
- [ ] 添加Token验证
- [ ] 添加权限验证(F.2.9)
- [ ] 调用Manager层方法
- [ ] 处理返回结果

第五步: 测试验证
- [ ] 编译验证
- [ ] Swagger文档确认
- [ ] 单元测试:账期计算逻辑
- [ ] 集成测试:完整流程测试

---

## 7. 接口示例

### 7.1 请求示例
POST /api/PlJob/ReopenAccountingPeriod
{
  "token": "xxx-xxx-xxx",
  "isUncloseJobs": true
}

### 7.2 成功响应示例
{
  "hasError": false,
  "errorCode": 0,
  "oldAccountingPeriod": "202508",
  "newAccountingPeriod": "202507",
  "unclosedJobCount": 23,
  "message": "成功将账期从202508倒退至202507,解关23个工作号"
}

### 7.3 失败响应示例
{
  "hasError": true,
  "errorCode": 400,
  "debugMessage": "无法倒退账期:当前账期202501已是最小账期"
}

---

计划制定时间: 2025-01-31
预计开发时间: 1个工作日(确认业务规则后)
风险等级: 中等

备注: 前端对接相关的内容由前端自行处理,后端只提供API接口

