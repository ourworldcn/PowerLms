# 账期反关闭(Re-open Period)功能开发计划

## 1. 需求分析

### 1.1 业务背景
配合财务操作习惯(类似金蝶),允许"反结账/反关闭",将当前账期倒退一个月(如从8月退回7月)

### 1.2 关键逻辑限制
- 逐月倒退: 只能8月到7月到6月,不可跳跃
- 可选解关: 通过isUncloseJobs参数控制是否同时解关该账期下的所有工作号
  - 勾选: 工作号恢复为可编辑状态
  - 不勾选: 仅账期回退,工作号仍保持关闭状态

### 1.3 业务价值
- 场景A(仅调账期): 财务发现账期设置错误,需要倒退但不影响业务数据
- 场景B(调业务): 需要修改已关闭工作号的业务数据,必须解关工作号

---

## 2. 技术方案设计

### 2.1 数据模型分析
已有字段(基于PowerLmsData索引):
- PlOrganizationParameter.CurrentAccountingPeriod: 当前账期(YYYYMM格式)
- PlOrganizationParameter.OrgId: 主键,存储**公司ID**(不是任意机构ID)
- PlJob.OrgId: 工作号所属机构ID(可以是公司或下属机构)
- PlJob.JobState: 工作号状态(16=已关闭)
- PlJob.CloseDate: 关闭时间
- PlJob.ClosedBy: 关闭人
- PlJob.AccountDate: 财务日期(用于判断归属账期)

机构层级关系:
- PlOrganization.Otc: 机构类型(2=公司, 4=普通机构)
- PlOrganization.ParentId: 父机构ID
- PlOrganization.Children: 子机构列表

无需新增字段: 现有字段足够支持反关闭逻辑

**重要说明**:
- 账期是**公司级别**的概念,每个公司独立管理
- PlOrganizationParameter.OrgId实际存储的是公司ID(Otc=2)
- 工作号可以归属于公司或其下属机构
- 反关闭时需要解关公司及其所有下属机构的工作号

### 2.2 核心逻辑设计(已确认)
账期回退逻辑: 当前账期202508 到 目标账期202507

工作号解关逻辑:
  IF isUncloseJobs = true:
    1. 计算目标账期的日期范围(202507 = 2025-07-01 到 2025-08-01)
    2. 查找所有满足条件的工作号:
       - OrgId IN (公司ID及其所有下属机构ID)
       - JobState = 16 (已关闭)
       - AccountDate >= 2025-07-01 AND AccountDate < 2025-08-01
    3. 批量更新:
       - JobState = 8 (已审核,可编辑)
       - CloseDate = null
       - ClosedBy = null
  ELSE:
    仅更新机构参数表的账期,不触碰工作号

注意事项:
- 按财务日期(AccountDate)判断,不是按创建日期
- 账期是按**公司**级别管理,工作号按**机构**级别存储
- 需要获取公司及其所有下属机构的ID集合来过滤工作号
- 使用OrgManager.GetOrgIdsByCompanyId(companyId)获取机构ID集合

### 2.3 安全校验设计(已确认)
1. 权限验证: 复用F.2.9权限(关闭账期权限)
2. 账期连续性: 不允许跳跃,只能逐月倒退(从逻辑上保证)
3. 最小账期: 不限制,理论上可以一直倒退
4. 混合状态: 允许倒退后的账期同时存在已关闭和未关闭的工作号

---

## 3. 账期获取方案详解(已确认)

### 3.1 账期的层级关系
```
商户(PlMerchant)
  └─ 总公司(PlOrganization, Otc=2, ParentId=null)
      ├─ 子公司A(PlOrganization, Otc=2)
      │   ├─ 部门A1(PlOrganization, Otc=4)
      │   └─ 部门A2(PlOrganization, Otc=4)
      └─ 子公司B(PlOrganization, Otc=2)
          └─ 部门B1(PlOrganization, Otc=4)

账期归属: 每个【公司】(Otc=2)独立管理账期
工作号归属: 可以归属于公司或其下属机构
```

### 3.2 OrgManager提供的关键方法
经代码查询确认,OrgManager提供以下方法:

1. **GetCurrentCompanyByUser(Account user)**
   - 功能: 获取用户当前登录的公司对象
   - 返回: PlOrganization(Otc=2)或null
   - 用途: Controller层获取当前公司

2. **GetCompanyIdByOrgId(Guid orgId)**
   - 功能: 获取指定机构所属的公司ID
   - 返回: Guid?(公司ID)或null
   - 用途: 从任意机构ID向上查找所属公司

3. **GetOrgIdsByCompanyId(Guid companyId)**
   - 功能: 获取公司及其所有下属机构的ID列表
   - 返回: IReadOnlyList<Guid>
   - 用途: 解关工作号时过滤机构范围

### 3.3 获取当前账期的完整流程

#### Controller层实现:
```csharp
// 第一步: 获取用户所属公司
var currentCompany = _OrgManager.GetCurrentCompanyByUser(context.User);
if (currentCompany == null)
{
    return NotFound("未找到用户所属公司");
}

// 第二步: 用公司ID查询账期
var parameter = _DbContext.PlOrganizationParameters
    .FirstOrDefault(p => p.OrgId == currentCompany.Id);

if (parameter == null)
{
    return NotFound($"公司{currentCompany.Name_DisplayName}未配置参数");
}

var currentPeriod = parameter.CurrentAccountingPeriod;
if (string.IsNullOrEmpty(currentPeriod))
{
    return BadRequest("当前账期为空,请先配置账期");
}
```

#### Manager层实现:
```csharp
public ReopenAccountingPeriodResult ReopenAccountingPeriod(
    Guid companyId,  // 传入公司ID
    bool isUncloseJobs, 
    Guid operatorId, 
    PowerLmsUserDbContext dbContext)
{
    // 第一步: 获取当前账期
    var parameter = dbContext.PlOrganizationParameters
        .FirstOrDefault(p => p.OrgId == companyId);
    
    if (parameter == null)
    {
        return new ReopenAccountingPeriodResult 
        { 
            Success = false, 
            ErrorMessage = "公司参数未配置" 
        };
    }
    
    var currentPeriod = parameter.CurrentAccountingPeriod;
    if (string.IsNullOrEmpty(currentPeriod))
    {
        return new ReopenAccountingPeriodResult 
        { 
            Success = false, 
            ErrorMessage = "当前账期为空" 
        };
    }
    
    // 后续逻辑...
}
```

### 3.4 工作号解关的机构范围处理
```csharp
// 获取公司及其所有下属机构的ID集合
var orgIds = _OrgManager.GetOrgIdsByCompanyId(companyId).ToArray();

// 查询需要解关的工作号(工作号可能归属于公司或其下属机构)
var jobsToUnclose = dbContext.PlJobs
    .Where(j => orgIds.Contains(j.OrgId) &&  // 关键:按机构ID集合过滤
               j.JobState == 16 && 
               j.AccountDate >= startDate && 
               j.AccountDate < endDate)
    .ToList();
```

### 3.5 关键理解总结
1. **账期存储**: PlOrganizationParameter.OrgId存的是**公司ID**(Otc=2)
2. **账期查询**: 通过公司ID查询,不是通过用户的机构ID
3. **工作号过滤**: 需要获取公司及所有下属机构的ID集合
4. **OrgManager方法**: GetCurrentCompanyByUser方法**已存在**,无需自己实现
5. **现有代码问题**: CloseAccountingPeriod方法直接用context.User.OrgId查询,在用户登录到部门时会出错

---

## 4. 实施计划

### 4.1 Manager层业务逻辑
位置: PowerLmsServer/Managers/Business/JobManager.cs

新增方法: ReopenAccountingPeriod
参数: companyId, isUncloseJobs, operatorId, dbContext
返回: ReopenAccountingPeriodResult

实现步骤:
1. 获取当前账期(通过companyId从PlOrganizationParameter表查询)
2. 计算目标账期(当前账期-1个月)
3. 验证账期有效性(格式YYYYMM)
4. 更新机构参数表(PlOrganizationParameter.CurrentAccountingPeriod)
5. 如果isUncloseJobs=true,批量解关工作号(按companyId过滤)
6. 记录操作日志

**账期获取说明**:
- 账期是按**公司**级别管理,不是按机构级别
- PlOrganizationParameter.OrgId存储的是公司ID(PlOrganization.Otc=2)
- 每个公司独立管理自己的账期

### 4.2 Controller层API接口
位置: PowerLmsWebApi/Controllers/Business/Common/PlJobController.cs

新增方法: ReopenAccountingPeriod(HttpPost)

实现步骤:
1. Token验证
2. 获取用户所属公司(使用OrgManager.GetCurrentCompanyByUser)
3. 权限验证(F.2.9)
4. 调用JobManager.ReopenAccountingPeriod(传入companyId)
5. 返回结果(旧账期/新账期/影响的工作号数量)

**关键代码逻辑**:
```csharp
// 获取用户所属公司
var currentCompany = _OrgManager.GetCurrentCompanyByUser(context.User);
if (currentCompany == null)
{
    return NotFound("未找到用户所属公司");
}

// 调用Manager层方法
var result = _JobManager.ReopenAccountingPeriod(
    currentCompany.Id,  // 传入公司ID
    model.IsUncloseJobs,
    context.User.Id,
    _DbContext
);
```

### 4.3 DTO定义
位置: PowerLmsWebApi/Controllers/Business/Common/PlJobController.Dto.cs

新增类:
- ReopenAccountingPeriodParamsDto: 参数类(Token, IsUncloseJobs)
- ReopenAccountingPeriodReturnDto: 返回类(OldAccountingPeriod, NewAccountingPeriod, UnclosedJobCount, Message)

### 4.4 Manager层结果模型
位置: PowerLmsServer/Managers/Business/JobManager.cs

新增类: ReopenAccountingPeriodResult
包含: Success, OldPeriod, NewPeriod, UnclosedJobCount, ErrorMessage

---

## 5. 已确认的业务规则

### 5.1 核心规则:反关闭后解关哪些工作号
**确认结果**: 解关倒退后账期的工作号
- 当前账期8月(202508),反关闭到7月(202507)
- 如果勾选"同时解关工作号",解关财务日期在7月(202507)的已关闭工作号
- 按财务日期(AccountDate)计算

### 5.2 账期倒退限制
**确认结果**: 不限制
- 理论上可以一直倒退,只要操作人需要
- 通过权限控制(F.2.9)即可

### 5.3 账期可以混合状态
**确认结果**: 允许
- 反关闭后,倒退账期可能同时存在:
  - 之前遗漏未关闭的工作号
  - 本次反关闭解关的工作号
- 由财务人员自己判断和处理

### 5.4 费用状态不变
**确认结果**: 费用状态保持不变
- 解关工作号后,已结算的费用仍然是"已结算"状态
- 如需修改费用,财务需要先:删除结算单→删除申请单→删除账单→修改费用

---

## 6. 业务控制体系说明(已确认)

### 6.1 双线控制模式
货代行业的业务控制采用**业务主管**和**财务主管**互相制约的模式:
- **业务线**: 工作号的关闭、审核(控制业务信息数据)
- **财务线**: 申请单、结算单(控制费用)

### 6.2 财务月=账期
- **财务月就是账期**: PlOrganizationParameter.CurrentAccountingPeriod
- 与金蝶等财务软件的概念相呼应
- **财务日期**: PlJob.AccountDate字段

### 6.3 本次实施范围
**明确范围**: 本次只实现工作号的反关闭功能
- 实现: 账期倒退 + 工作号解关
- 不涉及: 申请单、结算单的财务月校验
- 不涉及: 新建工作号的财务日期校验(这些是现有功能或未来功能)

---

## 7. 后端实施顺序

第一步: Manager层实现
- [ ] 在JobManager.cs中添加ReopenAccountingPeriodResult类
- [ ] 在JobManager.cs中实现ReopenAccountingPeriod方法
- [ ] 实现账期计算逻辑(YYYYMM-1个月)
- [ ] 实现工作号批量解关逻辑

第三步: DTO定义
- [ ] 在PlJobController.Dto.cs中添加请求DTO
- [ ] 在PlJobController.Dto.cs中添加返回DTO

第四步: Controller层实现
- [ ] 在PlJobController.cs中实现ReopenAccountingPeriod接口
- [ ] 添加Token验证
- [ ] 添加权限验证(F.2.9)
- [ ] 调用Manager层方法
- [ ] 处理返回结果

第五步: 测试验证
- [ ] 编译验证
- [ ] Swagger文档确认
- [ ] 单元测试:账期计算逻辑
- [ ] 集成测试:完整流程测试

---

## 8. 接口示例

### 8.1 请求示例
POST /api/PlJob/ReopenAccountingPeriod
{
  "token": "xxx-xxx-xxx",
  "isUncloseJobs": true
}

### 8.2 成功响应示例
{
  "hasError": false,
  "errorCode": 0,
  "oldAccountingPeriod": "202508",
  "newAccountingPeriod": "202507",
  "unclosedJobCount": 23,
  "message": "成功将账期从202508倒退至202507,解关23个工作号"
}

### 8.3 失败响应示例
{
  "hasError": true,
  "errorCode": 400,
  "debugMessage": "无法倒退账期:当前账期202501已是最小账期"
}

---

计划制定时间: 2025-01-31
预计开发时间: 1个工作日(确认业务规则后)
风险等级: 中等

备注: 前端对接相关的内容由前端自行处理,后端只提供API接口

