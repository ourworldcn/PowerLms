# PowerLms 项目需求会议纪要整理汇总

## 📅 会议信息
- **第一次会议：** 2025年08月16日 - 需求评审与问题研讨
- **第二次会议：** 2025年08月23日 - 进度回顾与技术细节澄清
- **与会人员：** 石永昌(PM/产品)、陈云霄(前端)、ZC@WorkGroup(后端)

## 🎯 项目总体状况

### 时间线与风险
- **目标：** 9月2日前完成核心功能，留出最终测试窗口
- **关键节点：** 8月底必须完成阻塞性任务
- **测试策略：** 9月整月进行"生产环境并行测试"（廊坊、西安分公司）
- **主要风险：** 模块强耦合，缺少传统内测环节，首次并行时数据不一致概率高

### 项目架构挑战
- **耦合问题：** 业务-财务-审批强耦合，无法孤立测试
- **测试价值：** 需端到端打通才能形成有效测试
- **管理预期：** 需向管理者明确"测试即完善"的必要性

---

## 📋 核心功能需求详解

### 1️⃣ 申请单审批回退机制

#### 业务背景
- **问题场景：** 申请单已走完审批流程甚至已付款，事后发现内容错误
- **核心目标：** 允许修改错误申请单并重新提交，关键在于释放被锁定的费用

#### 技术方案（方案B - 一键回退）
1. **权限控制：** 专门权限，非人人可用
2. **操作日志：** 回退前生成申请单状态与审批节点快照存入系统日志
3. **清空审批流：** 删除所有已生成的审批流节点
4. **状态回退：** 申请单主表状态改回"初始状态/未提交"
5. **保留明细：** 表头和明细数据保留，允许用户修改，触发trigger释放关联费用
6. **消息通知：** 向审批流相关人员发送"已撤销"通知

#### 特殊处理
- **账期关闭关系：** 工作号被"关闭"不影响申请单回退
- **调账处理：** 可在后续月份新建"调账工作号"处理已关闭工作号的账务差异
- **拒绝逻辑：** Reject操作同步改造，拒绝后退回初始状态释放费用

#### 适用范围
- 主营业务申请单
- OA费用申请单

#### 实施状态
- ✅ **Manager层已完成** - JobManager.RevertJobRequisition & OaExpenseManager.RevertRequisition
- ✅ **工作流清理已完成** - OwWfManager.ClearWorkflowByDocId 
- ✅ **回退结果类型已定义** - RevertResult & OaExpenseRevertResult
- ✅ **主营业务Controller API已完成** - PlJobController.RevertJobRequisition
- ✅ **OA费用Controller API已完成** - OaExpenseController.RevertOaExpenseRequisition
- ✅ **命名规范化完成** - 统一使用"Requisition"而非"Application"

---

### 2️⃣ 数据导入导出功能重构

#### 设计原则调整
- **原设计：** 一次性导出所有关联字典 → **新设计：** 按"单表（表名称）"导入导出
- **统一接口：** 前端通过获取"支持的表清单"直接选择具体表名

#### 简单字典（Simple Dictionary）处理
**技术挑战：**
- 不同公司Catalog Id不同，导出不含分类唯一标识会导致导入错位

**解决方案：**
- **导出：** Excel每行包含父级分类`catalog_code`列
- **接口参数：** 支持可选`catalog_code`参数
  - 传入参数：导出指定分类
  - 不传参数：导出全部简单字典数据
- **导入：** 根据登录机构`org_id`与每行`catalog_code`匹配分类Id

#### 客户资料（Customer Profile）
- **范围限制：** 当前阶段仅处理主表导入导出
- **子表处理：** 暂不支持Excel导入，用户在系统内维护

#### 其他单表字典
- **补全需求：** 汇率(PlExchangeRate)、港口(PlPort)等单表字典
- **处理方式：** 与客户资料主表逻辑一致，整表导入导出

#### 数据处理策略
- **重复数据：** 对`code`重复采用覆盖(Update)策略
- **依赖关系：** 导入时验证依赖字典，不存在则阻止导入

#### 实施状态
- ✅ **架构重构已完成** - CHANGELOG.md v2.0版本确认
- ✅ **简单字典专用API已实现** - 支持catalog_code跨公司迁移
- ✅ **批量多表处理已实现** - 删除单表模式，统一批量处理

---

### 3️⃣ 账期管理与工作号关闭机制

#### 核心概念
- **账期定义：** 每个公司独立账期，格式YYYYMM（如202508）
- **存储方式：** 机构参数表，与机构1:1关联

#### 关闭账期流程
1. **权限要求：** 财务人员专用权限
2. **批量操作：** 所有"财务日期"落在该账期的工作号置为"已关闭"
3. **费用锁定：** 关闭后工作号任何费用不可修改
4. **自动递增：** 当前账期自动+1（202508→202509）

#### 机构参数表设计
**必需字段：**
- `current_accounting_period`：当前账期（字符串，只读，经"关闭账期"更新）
- `账单抬头1`、`账单抬头2`、`账单落款`：报表打印用

#### 功能废弃
- **取消方式：** 原手动/单票/批量关闭工作号功能废弃
- **统一管理：** 所有关闭通过"关闭账期"操作完成

#### 实施状态
- ✅ **机构参数表实体已创建** - PlOrganizationParameter.cs
- ✅ **机构参数表Controller已创建** - OrganizationParameterController.cs
- ✅ **账期管理API已实现** - CloseAccountingPeriod & PreviewAccountingPeriodClose
- ✅ **权限控制已配置** - 使用"F.2.9"权限控制关闭账期操作

---

## 🔧 API接口问题与Bug修复

### 1. 空运进口接口丢失（IA）
- **问题：** Swagger文档不显示，相关功能受阻
- **代码审查发现：** 空运进口实体PlIaDoc存在，DTO定义存在于PlJobController.Dto.cs中
- **真实问题：** 缺少空运进口的CRUD Controller实现，需要创建对应的action方法
- **状态：** ❌ **需要实现** - 在PlJobController中添加空运进口的CRUD接口

### 2. 费用反查申请单明细过滤失败
- **问题：** `fee-request-details`接口按`fee_id`过滤未生效，返回所有明细
- **代码位置：** FinancialController.DocFeeRequisition.cs
- **状态：** ❌ **需要修复** - GetDocFeeRequisitionItem方法中的过滤逻辑

### 3. 结算单导出到金蝶
- **问题：** 日常办公模块下收付款单导出到金蝶未完成
- **决议：** 逻辑复杂，优先级暂缓
- **状态：** ⏸️ **暂缓**

---

## 📊 服务器端任务优先级与分工

### 🔴 **第一优先级（接口实现）**
1. **创建空运进口CRUD接口** - 在PlJobController中添加GetAllPlIaDoc、AddPlIaDoc、ModifyPlIaDoc、RemovePlIaDoc
2. **修复费用过滤Bug** - fee_id过滤逻辑修复

### 🟡 **第二优先级（功能完善）**  
1. **OA费用申请单增加公司字段** - customerId字段添加
2. **验证账期管理完整性** - 测试关闭账期功能

### 🟢 **第三优先级（功能扩展）**
1. **结算单导出到金蝶** - 复杂功能暂缓

---

## 📈 项目状态总览

### ✅ 已完成
- **申请单回退Manager层实现** - JobManager & OaExpenseManager
- **申请单回退Controller API实现** - 主营业务 & OA费用双实现
- **工作流清理机制** - OwWfManager.ClearWorkflowByDocId
- **导入导出服务架构重构（v2.0）** - 简单字典API专用接口
- **机构参数表完整实现** - 实体、Controller、CRUD、账期管理
- **账期管理API实现** - 关闭账期、预览影响范围
- **财务日期处理逻辑** - PlJob.AccountDate字段正确配置

### 🔄 进行中
- 空运进口CRUD接口实现

### ❌ 待完成（阻塞项）
- **空运进口CRUD接口实现**（最高优先级）
- **费用过滤Bug修复**
- **OA申请单公司字段添加**

### ⏸️ 暂缓
- 结算单导出到金蝶功能

---

## 🚨 关键风险提醒

1. **空运进口接口缺失** - 需要在PlJobController中补全CRUD操作
2. **费用过滤Bug** - 影响费用明细查询功能
3. **时间压力** - 8月底前必须完成核心阻塞项

---

## 📝 后续行动建议

1. **立即行动：** 在PlJobController中实现空运进口的完整CRUD接口
2. **紧急修复：** 费用过滤Bug和OA申请单字段添加
3. **质量保证：** 每个模块完成后立即进行端到端测试

---

## 🔍 **代码审查总结**

通过对现有代码的详细审查发现：

### ✅ **已完成的重要功能**
1. **申请单回退机制** - 完整实现包括Manager层和Controller层
2. **机构参数表和账期管理** - 完整的实体、Controller、业务逻辑
3. **导入导出架构重构v2.0** - 已完成并在CHANGELOG.md中确认
4. **工作流清理机制** - 完整的级联删除和日志记录

### ❌ **需要完成的关键任务**
1. **空运进口CRUD接口** - PlIaDoc的增删改查操作未在Controller中实现
2. **费用过滤逻辑修复** - fee_id参数过滤功能异常
3. **OA申请单公司字段** - customerId字段添加

### 📊 **优先级重新评估**

基于代码审查，主要的阻塞项已经大幅减少：

1. **🔴 第一优先级：** 空运进口CRUD接口实现
2. **🟡 第二优先级：** Bug修复和字段添加  
3. **🟢 第三优先级：** 功能扩展和优化

**重要发现：** 
- 机构参数表和账期管理功能已经完整实现，不是之前认为的"完全未实现"
- 申请单回退功能的Controller API也已经完成
- 主要缺失的是空运进口的Controller接口实现

这大大降低了项目风险，核心功能基本就绪，只需要补全空运进口接口即可