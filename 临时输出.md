# 会议备忘录（合并版）：需求评审、进度回顾与技术细节澄清

合并来源：
- 上期会议纪要（2025-08-16）- 文件：会议纪要.md
- 本期会议备忘录（2025-08-23）- 文件：临时输入.md

与会人员（两次会议一致）：
- 石永昌 (PM/产品)
- 陈云霄 (前端)
- ZC@WorkGroup (后端)

---

## 一、总体概览（两期合并）

- 项目节奏与测试策略：9月开展"生产环境并行测试"，在单机版与新系统同步录入真实数据，对齐月底报表。时间是核心风险，需在8月底前完成阻塞项。
- 关键业务功能：
  - 申请单"一键回退"（撤销/回退）机制（上一期确定，需实现权限、日志、清空审批流、状态回退、消息通知）。
  - 导入导出逻辑明确：按"单表（表名称）"导入导出；简单字典需按`catalog_code`实现跨公司正确关联；客户资料阶段仅支持主表；补全单表字典（汇率、港口等）。
  - 账期管理：引入公司维度账期参数，统一"关闭账期"批量关闭工作号并自动递增账期；废弃单票/批量关闭方式。
- API与BUG：恢复空运进口(IA)接口；修复费用明细`fee_id`过滤；金蝶导出暂缓但前端需预留"日常收款/日常付款"选项。
- 前端UI/UX：付款单已勾销隐藏实付类字段；菜单优化与更名；费用弹窗字段修正；客户资料有效性开关；客户选择器增强；费用列表可查看所关联申请单。
- 时间目标与优先级：8月底完成核心，9月并行测试；下周明确的后端/前端优先级分工。

---

## 二、项目进度、风险与测试策略（本期新增）

- 背景：8/16确定的诸多功能未完工，若9/1前无法交付可测版本，将导致严重延期。
- 挑战：模块强耦合（业务-财务-审批），无法孤立测试；需端到端打通以形成有效测试价值。
- 决策：9月采用“生产环境并行测试”模式（廊坊、西安分公司），整月同步录入真实数据，月底报表必须对齐。
- 风险共识：缺少传统内测环节，首次并行时数据不一致概率高，需要对管理者（老郭）明确预期，强调“测试即完善”的必要性。
- 主要风险：时间——务必8月底前完成核心阻塞项。
- 会议决议：
  - 全力优先完成阻塞性任务，保障9月并行测试。
  - 向管理者同步风险与策略，管理预期。

---

## 三、申请单审批流程的回退与作废（上期确定）

- 背景：已走完审批甚至已付款后发现错误，需允许修改并释放被锁定费用。
- 目标：回退到“未提交”初始状态，释放费用锁定，保留数据可编辑。
- 方案：采用方案B“一键回退”。
  1. 权限控制：专门权限方可执行。
  2. 记录日志：操作前对申请单状态与审批节点快照入系统日志。
  3. 清空审批流：删除已生成的审批流节点。
  4. 状态回退：主表状态改回“未提交”。
  5. 保留明细：保留表头/明细，编辑触发触发器以正确释放/联动费用。
  6. 消息通知：向审批流相关人员发送“已撤销”通知。
- 与账期关闭的关系：工作号被“关闭”不影响申请单回退。工作号仅锁定自身费用修改，不阻止申请单中调整/移除关联。可在后续月份新建“调账工作号”（含负数费用）处理差异，并合并在同一申请单提交。
- 会议决议：
  - 适用：主营业务申请单、OA费用申请单。
  - 拒绝(Reject)逻辑同步改造：拒绝后退回初始状态以释放费用。
- 行动项（后端）：
  - 新增“一键回退”接口（权限、日志、清流、回退、通知）。
  - 修改拒绝逻辑，实现退回初始状态。
- 行动项（前端）：
  - 在界面按权限显示“撤销/回退”按钮并调用接口。

---

## 四、数据导入导出功能（两期合并，统一为“单表（表名称）导入导出”）

### 4.1 总体原则
- 所有导入导出均按“单表（表名称）”进行，前端通过获取“支持的表清单”直接选择具体表名。
- 简单字典（Simple Dictionary）需包含并依赖`catalog_code`确保跨公司/机构下的数据归属正确。

### 4.2 简单字典（Simple Dictionary）
- 问题（本期深化）：简单字典存在不同Catalog，各公司的Catalog Id不同；若导出不含分类唯一标识`code`，导入会错位。
- 方案演进：
  1) 早期“分类型导出/导入”（需逐一操作，体验差）。
  2) 最终方案（统一接口、灵活处理）：
     - 导出：Excel每行包含父级分类`catalog_code`列；接口接受可选参数`catalog_code`，传入则导出该分类，不传则导出全部简单字典数据。
     - 导入：根据登录机构`org_id`与每行`catalog_code`匹配分类Id，确保跨公司迁移时关联正确。
- 行动项（后端）：改造简单字典导入导出接口，保证导出包含`catalog_code`，支持带参/不带参导出；导入按`org_id+catalog_code`落库。
- 行动项（前端）：在分类处提供“导入/导出”（传`catalog_code`）按钮，并预留全局入口（不传参）。

### 4.3 客户资料（Customer Profile）
- 决议：当前阶段仅处理“主表”导入导出（名称、简称、编码等），子表信息暂不Excel导入，用户在系统内维护。
- 行动项（后端）：确保客户资料仅主表导入导出。
- 行动项（前端）：界面逻辑与之保持一致。

### 4.4 其他单表字典（汇率、港口等）
- 问题：可导入导出列表缺少汇率、港口等单表字典。
- 决议：与客户资料主表逻辑一致，属于整表导入导出。
- 行动项（后端）：在“支持的表清单”白名单中补齐（如PlExchangeRate、PlPort等）。

### 4.5 上期共识补充
- 导出范围：从“一次性导出所有关联字典”更正为“按类型分别导出”（现统一为按“表名称”单表导出）。
- 重复数据处理：对`code`重复采用覆盖（Update）策略，以“与导入文件一致”为目标。
- 依赖关系校验：若依赖字典数据不存在，导入将阻止并提示。

---

## 五、账期管理与工作号关闭机制（上期确定）

- 引入概念：每个公司（机构）独立账期（YYYYMM，如202508），存放于“机构参数表”（与机构1:1）。
- 关闭账期（有权限操作）：
  - 执行后，所有“财务日期”落在该账期的工作号（PR Job）统一置为“已关闭”。
  - 关闭后该工作号任何费用不可再修改。
  - 当前账期自动+1（如202508→202509）。
- 取消单票关闭：启用统一“关闭账期”后，原手动/单票/批量关闭方式废弃。
- 机构参数表（新增）：
  - 字段：
    - `current_accounting_period`（当前账期，字符串，只读，经“关闭账期”更新）。
    - `账单抬头1`、`账单抬头2`、`账单落款`（报表打印用）。
  - 编辑该表需单独权限。
- 行动项（后端）：
  - 新建机构参数表与模型；提供CRUD；实现“关闭账期”接口（批量关闭与账期推进）。
- 行动项（前端）：
  - 提供“机构参数配置”界面（编辑抬头/落款；显示只读账期）；
  - 在“单票审核/财务区”增加“关闭账期”按钮并配置权限。

---

## 六、API 接口问题与 Bug 修复（本期新增）

1) 空运进口接口丢失（IA）：
   - 问题：Swagger文档不显示，相关功能受阻。
   - 行动项（后端）：查明原因并恢复空运进口全部CRUD接口。

2) 费用反查申请单明细过滤失败：
   - 问题：调用“获取费用申请单明细（fee-request-details）”时，按`fee_id`过滤未生效，返回所有明细。
   - 决议：确认为通用查询过滤BUG。
   - 行动项（后端）：修复`fee_id`过滤逻辑。

3) 结算单导出到金蝶：
   - 问题：日常办公模块下收付款单（其他费用结算单）导出到金蝶尚未完成。
   - 决议：逻辑复杂，优先级暂缓；前端弹窗需新增“日常收款/日常付款”选项以预留入口。
   - 行动项：
     - 前端：在“导出到金蝶”弹窗中增加上述两个选项。
     - 后端：本周暂不开发，预留后续实现接口规划。

---

## 七、前端 UI/UX 优化与调整（两期合并）

- 付款单界面调整（本期）：已勾销状态下隐藏“实付金额/实付币种”。
- 菜单调整（本期）：
  1. “日常办公”菜单项移至“统计报表”之前。
  2. “日常办公/报销申请”改名为“其他费用申请”。
  3. “日常办公/报销审批”改名为“其他费用审批”。
  4. 删除“报销再申请”菜单项。
- 财务日期逻辑确认（本期）：
  - 后端`account_date`字段不改动；前端改为只读并由“到港日期(进口)/开航日期(出口)”自动填充。
  - 后端在关账/计提等功能中直接读取该字段即可，无需新增计算字段。
- 费用列表显示申请单详情（上期）：点击“已申请金额”弹窗展示关联申请单关键信息（单号/金额/申请人/时间）；无需跳转，可复制单号。
- OA费用申请单新增“公司”字段（上期）：主表新增`customerId`（关联客户资料），前端增加公司选择器。
- 客户资料有效性管理（上期）：
  - 增加“有效/无效”状态（软删除）。
  - 列表提供带权限的“启用/停用”按钮，走单独接口。
  - 各处客户选择默认仅显示“有效”客户。
- 客户选择器优化（上期）：
  - 改为弹窗式选择器，展示更多字段（名称、简称、财务编码、是否超期、是否超额）。
  - 支持按名称/简称/财务编码模糊搜索。
  - 按业务场景过滤客户类型（委托单位仅客户；承运人仅航司/船司）。
- 文本修正（本期）：费用“已申请金额”弹窗最后一列列名由“刘先生”改为“申请人”。

---

## 八、时间计划与优先级（两期合并）

- 里程碑：
  - 目标：所有变更在9月2日前完成，留出最终测试窗口。
  - 风险：一键回退与账期管理为核心流程改造，复杂度较高。

- 下周工作优先级（本期明确）：
  - 后端优先：
    1) 完成“增加/修改字段”等简单任务，解除前端依赖。
    2) 实现“简单字典统一导入导出接口”（含`catalog_code`方案）。
    3) 恢复空运进口(IA) CRUD接口。
    4) 修复“费用反查申请单明细”的`fee_id`过滤BUG。
  - 前端跟进：
    1) 配合已完成接口与字段，完成UI/UX调整。
    2) 实现简单字典与客户资料导入导出界面。
  - 后续（下周末或更后）：
    1) 开发“一键回退”和“账期管理”。
    2) 开发“结算单导入金蝶”。

---

## 九、行动项汇总（按角色）

- 后端 ZC@WorkGroup：
  - 一键回退接口开发与拒绝逻辑改造；记录日志、清空审批流、状态回退、消息通知。
  - 简单字典导入导出改造：导出每行含`catalog_code`；导入按`org_id+catalog_code`归类；支持带参/不带参导出。
  - 客户资料导入导出仅限主表；补齐单表字典（汇率、港口等）清单。
  - 恢复空运进口(IA) CRUD接口。
  - 修复“fee-request-details”接口的`fee_id`过滤。
  - 机构参数表与“关闭账期”接口：批量关闭PR Job、账期自动递增；提供CRUD并控制权限。
  - 后端在关账/计提等流程中直接读取`account_date`（不新增计算字段）。

- 前端 陈云霄：
  - 申请单界面增加“撤销/回退”按钮（按权限显示）。
  - 简单字典导入导出UI：分类内按钮（传`catalog_code`）+ 全局入口（不传）。
  - 客户资料导入导出仅主表；付款单勾销后隐藏实付类字段；菜单位置与命名调整；
  - 费用“已申请金额”弹窗字段更名为“申请人”；费用列表弹窗展示关联申请单详情。
  - 客户资料有效性“启用/停用”按钮与默认仅显示“有效”客户；
  - 客户选择器弹窗：更多字段、模糊搜索、按业务场景过滤。
  - 新增“机构参数配置”界面与“关闭账期”入口（权限管控）。
  - 在“导出到金蝶”弹窗中增加“日常收款/日常付款”选项。

- 管理者沟通：
  - 向老郭同步并行测试风险与策略，明确“测试即完善”，管理期望。

---

## 十、附录：关键信息对照

- 并行测试：9月整月在两地公司同步录入真实数据，月底报表需一致。
- 导入导出原则：按表名称单表导入导出；简单字典每行带`catalog_code`；客户资料阶段仅主表；补齐汇率/港口等字典。
- 账期管理：统一“关闭账期”，批量关闭PR Job并自动推进账期；机构参数表存储`current_accounting_period`与报表抬头信息。
- 审批回退：一键回退（权限、日志、清流、回退、通知），拒绝同退初始，释放费用锁定。
- 重要待修复：空运进口(IA)接口、`fee_id`过滤。
- 前端要点：付款单勾销隐藏实付字段、菜单调整、更名修正、客户有效性管理、客户选择器增强、金蝶导出选项预留。

---

# PowerLms导入导出服务优化 - 变更概要

## 版本：2025-01-27 v2.0

### 🔄 主要变更
- **架构重构**：删除单表模式，统一使用批量多表处理
- **功能分离**：简单字典独立为专门API，通用表字典保持批量处理
- **性能优化**：批量操作、流式处理、减少数据库往返

### 📊 API变更说明

#### 简单字典API（新增专用接口）
- `GET /ImportExport/GetSimpleDictionaryCatalogCodes` - 获取Catalog Code列表
- `GET /ImportExport/ExportSimpleDictionary` - 导出简单字典（支持多Catalog）
- `POST /ImportExport/ImportSimpleDictionary` - 导入简单字典

#### 通用表字典API（保留批量模式）
- `GET /ImportExport/GetSupportedTables` - 获取支持的表类型
- `GET /ImportExport/ExportMultipleTables` - 批量导出多表
- `POST /ImportExport/ImportMultipleTables` - 批量导入多表

#### 删除的API（不兼容变更）
- `ExportTable`、`ImportTable`、`GetSupportedTableTypes` 等单表模式API已删除

### 📁 Excel文件要求
- **简单字典**：Sheet名称使用Catalog Code（如"COUNTRY"、"PORT"）
- **通用表**：Sheet名称使用实体类型名称（如PlCountry、PlCustomer）
- **文件格式**：仅支持.xls格式

### ⚠️ 重要提醒
- **兼容性**：客户端需要迁移到新的批量API
- **命名规范**：Excel Sheet命名必须严格按照要求
- **多租户**：自动应用OrgId数据隔离

---

**注意**：本次变更删除了废弃的单表模式API，客户端应用需要相应更新调用方式。新的批量处理架构提供了更好的性能和更清晰的功能分离。
