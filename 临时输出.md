# 会议备忘录

## 主营业务结算单
1. **字段依赖与联动**：
   - 明细表字段需与主单字段联动，部分字段依赖尚未完全实现。
   - 收款金额、付款金额等字段需根据应收应付动态调整。
   - 币种变更后需同步更新相关金额字段。

2. **界面优化**：
   - 当前界面布局较宽，建议调整为每行显示4个字段。
   - 界面联动逻辑复杂，需进一步优化。

3. **功能改进**：
   - 增加拆分按钮，支持多笔收款操作。
   - 审批流程需完善，权限报错问题待解决。

## OA日常费用
1. **接口问题**：
   - 结算与确认接口存在权限问题，需检查授权配置。

2. **导入导出功能**：
   - 支持所有字典的导入导出功能，包括客户资料、币种、汇率等。
   - 导出字段需固定，导入时需匹配表头字段。
   - 数据字典需支持中英文双语表头。

3. **数据一致性**：
   - 导入导出需确保GUID与Code的正确关联。
   - 避免因ID缺失导致数据无法导入。
   - 导出时避免导出ID字段，使用Code字段替代。
   - 导入时自动生成或匹配ID，确保数据完整性。

## 港口与航线
1. **港口编码**：
   - 空运港口使用三字码，海运港口使用五字码。
   - 在港口表中增加类型标识（空运/海运）。

2. **统计问题**：
   - 当前空运与海运数据分开统计，需支持按国家或航线合并统计。
   - 模糊查询需支持空运与海运的统一结果。

## 文件上传下载
1. **问题排查**：
   - 部分文件上传成功但无法下载，需检查接口版本。
   - 统一使用通用上传下载接口，废止旧接口。

2. **文件类型限制**：
   - 新接口需限定上传文件类型，避免上传不支持的文件格式。

## 界面交互与用户体验
1. **鼠标交互优化**：
   - 鼠标点击区域过小，需优化交互体验。
   - 增加全选功能，简化操作。

2. **界面布局调整**：
   - 界面布局需逐步优化，按优先级调整字段显示与交互逻辑。

## 审批与字段管理
1. **单票审核**：
   - 单票审核界面需增加关闭人和关闭日期字段。
   - 审核人与关闭人可为不同用户，权限需控制。

2. **字段关联**：
   - 确保新增字段与现有表头和关联表的正确映射。

## 后续计划
1. **基础资料导入导出**：
   - 优化导入导出功能，确保字段匹配与数据完整性。
   - 预计9月2日开始双系统同步录入。

2. **测试与部署**：
   - 完成基础资料导入导出功能后，上传测试版本供用户验证。
   - 检查并修复权限报错、文件下载等问题。
   - 确保导入导出功能的稳定性与数据一致性。

3. **界面优化**：
   - 按优先级逐步优化界面布局与交互逻辑。
   - 收集用户反馈，持续改进。

---

以上为会议讨论的主要内容与后续计划.

# PowerLms开发总结与外部工具使用指南

## 🎯 外部工具集成测试成功经验

### 外部工具基本信息
- **工具名称**: OwMcp Excel查询MCP服务器
- **访问地址**: https://localhost:5001/index.html
- **技术栈**: .NET 6 + NPOI + MCP协议
- **核心功能**: Excel文件上传、解析、查询

### ✅ 成功测试流程回顾

#### 1. 工具发现与连接
```bash
# 1. 首先测试工具连通性
curl.exe -k -v https://localhost:5001/index.html

# 2. 获取API规范
curl.exe -k -s https://localhost:5001/swagger/v1/swagger.json

# 3. 发现MCP功能
curl.exe -k -s https://localhost:5001/mcp/FileManager/GetMCPFunctions
curl.exe -k -s https://localhost:5001/mcp/Excel/GetMCPFunctions
```

#### 2. 文件上传测试
```bash
# 避免命令行JSON转义问题，使用文件方式
echo '{"uploadMode":"localPath","fileName":"预初始化数据.xlsx","localPath":"C:\\Users\\zc-home\\source\\ourworldcn\\PowerLms\\PowerLmsServer\\数据库初始化数据\\预初始化数据.xlsx"}' > upload_request.json

# 上传文件
curl.exe -k -X POST "https://localhost:5001/mcp/FileManager/UploadFile" -H "Content-Type: application/json" -d "@upload_request.json"

# 成功返回: {"fileId":"e58c3909-2c11-4bb3-b5ff-a33bf0bc42e2","uploadStatus":"completed","message":"文件上传完成","currentSize":315682}
```

#### 3. Excel数据解析
```bash
# 获取Excel元数据
echo '{"fileId":"e58c3909-2c11-4bb3-b5ff-a33bf0bc42e2","sampleRows":3}' > metadata_request.json
curl.exe -k -X POST "https://localhost:5001/mcp/Excel/GetExcelMetadata" -H "Content-Type: application/json" -d "@metadata_request.json"

# 查询工作表数据
echo '{"fileId":"e58c3909-2c11-4bb3-b5ff-a33bf0bc42e2","worksheetName":"TaxInvoiceChannels","pageIndex":0,"pageSize":10,"includeHeaders":true}' > worksheet_request.json
curl.exe -k -X POST "https://localhost:5001/mcp/Excel/GetWorksheetData" -H "Content-Type: application/json" -d "@worksheet_request.json"
```

### 🔧 核心技巧总结

#### PowerShell命令行最佳实践
1. **JSON避免转义**: 使用外部文件而非内联JSON字符串
2. **curl调用**: 使用`curl.exe`而非PowerShell别名
3. **HTTPS处理**: 添加`-k`参数跳过证书验证
4. **路径处理**: 使用双反斜杠转义Windows路径

#### 外部工具调用模式
1. **工具识别**: 先访问根路径了解工具性质
2. **API发现**: 查看swagger.json了解接口结构
3. **功能测试**: 使用GetMCPFunctions了解具体功能
4. **实际使用**: 按照标准MCP协议调用具体功能

### 📊 测试结果验证

#### 成功解析的Excel文件信息
- **文件**: PowerLms\PowerLmsServer\数据库初始化数据\预初始化数据.xlsx
- **大小**: 315,682 字节
- **工作表**: 20个工作表，包含完整的系统种子数据
- **数据类型**: 权限配置、科目设置、发票通道、币种、国家、港口等

#### 验证的功能点
- ✅ 文件上传（双模式：Base64分段 + 本地路径）
- ✅ Excel元数据解析（工作表列表、行列统计）
- ✅ 分页数据查询（高性能数据读取）
- ✅ MCP协议支持（标准化接口）

---

## 📋 下次提示词建议

### 对于外部工具使用场景

```
# 当需要测试Excel相关功能时的提示词模板：

请测试外部工具的Excel处理功能：
1. 使用外部工具 https://localhost:5001 
2. 上传指定的Excel文件进行解析
3. 验证数据读取和查询功能
4. 不要分析项目代码，专注测试外部工具
5. 使用JSON文件方式避免命令行转义问题
```

### 对于PowerShell操作场景

```
# 当需要执行PowerShell命令时的提示词模板：

请执行以下操作，注意PowerShell语法：
1. 使用curl.exe而非curl别名
2. 复杂JSON使用外部文件，避免转义
3. HTTPS请求添加-k参数
4. 路径使用双反斜杠转义
5. 不要使用Bash语法（如&&操作符）
```

### 对于.NET 6项目开发场景

```
# 当需要开发.NET 6功能时的提示词模板：

基于PowerLms项目开发新功能：
1. 工作区：.NET 6项目，分层架构（API→Server→Data）
2. 复用基础设施：OwFileService, OwWfManager, AuthorizationManager等
3. Excel处理使用：OwDataUnit + OwNpoiUnit
4. 禁止自动迁移，手动规划数据库变更
5. 确保权限验证和多租户隔离
```

---

## 🚀 关键成功经验

### 1. 工具理解先行
- 不要急于使用，先了解工具的性质和能力
- 通过API文档和功能发现接口了解完整功能
- 验证工具的技术栈和协议支持

### 2. 命令行操作标准化
- PowerShell语法限制严格遵守
- JSON数据使用文件方式传递
- curl调用使用真实可执行文件

### 3. 测试策略系统化
- 从简单连通性测试开始
- 逐步深入到复杂功能验证
- 使用实际业务数据验证完整流程

### 4. 错误处理经验化
- 命令行转义问题用文件解决
- 网络连接问题用-k参数跳过
- API调用问题查看swagger文档

---

## 💡 未来改进建议

### 外部工具集成
1. 考虑将外部工具的Excel处理能力集成到PowerLms主系统
2. 建立标准化的MCP协议调用封装
3. 优化文件上传和数据解析的性能

### 开发流程优化
1. 建立外部工具测试的标准化脚本
2. 完善PowerShell命令的错误处理机制
3. 建立测试数据和验证标准的文档库

这些经验为后续类似的外部工具集成和测试提供了宝贵的参考。